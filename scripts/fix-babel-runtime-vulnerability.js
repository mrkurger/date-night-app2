#!/usr/bin/env node

/**
 * This script fixes the @babel/runtime vulnerability by updating the package.json
 * in the node_modules directory to use the latest version.
 */

import * as fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const rootDir = path.resolve(__dirname, '..');
const clientAngularDir = path.join(rootDir, 'client-angular');

// Path to the @babel/runtime package.json in node_modules
const babelRuntimePackageJsonPath = path.join(
  clientAngularDir,
  'node_modules',
  '@babel',
  'runtime',
  'package.json',
);

console.log(`Checking for @babel/runtime package.json at ${babelRuntimePackageJsonPath}`);

// Check if the file exists
if (!fs.existsSync(babelRuntimePackageJsonPath)) {
  console.error(`Error: @babel/runtime package.json not found at ${babelRuntimePackageJsonPath}`);
  process.exit(1);
}

try {
  // Read the current package.json
  const packageJson = JSON.parse(fs.readFileSync(babelRuntimePackageJsonPath, 'utf8'));

  // Get the current version
  const currentVersion = packageJson.version;
  console.log(`Current @babel/runtime version: ${currentVersion}`);

  // Update to the required version (7.26.10 or higher)
  if (currentVersion < '7.26.10') {
    packageJson.version = '7.27.1'; // Use the version we have in devDependencies
    console.log(`Updating @babel/runtime version to 7.27.1`);

    // Write the updated package.json
    fs.writeFileSync(babelRuntimePackageJsonPath, JSON.stringify(packageJson, null, 2));
    console.log(`Successfully updated @babel/runtime package.json`);
  } else {
    console.log(`@babel/runtime version ${currentVersion} is already >= 7.26.10, no update needed`);
  }

  console.log('Vulnerability fix completed successfully');
} catch (error) {
  console.error(`Error updating @babel/runtime package.json: ${error.message}`);
  process.exit(1);
}
