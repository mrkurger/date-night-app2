# File: .github/workflows/codeql-analysis-pro.yml
name: "CodeQL Security Analysis (Pro+ Compatible)"

# This workflow runs CodeQL analysis without requiring GitHub Advanced Security
# Specifically configured to avoid Code Scanning API calls that cause warnings
# Results are saved as artifacts and posted to PR comments instead of Security tab
# Configured for JavaScript/TypeScript ONLY - No Python scanning

on:
  # Push events on main and develop branches trigger security scanning
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**/*.md'
      - '**/*.txt'
      - '.github/ISSUE_TEMPLATE/**'
      - 'docs/**'
  
  # Pull requests to main branch get scanned before merge
  pull_request:
    branches: [ main ]
    paths:
      - '**.js'
      - '**.ts'
      - '**.jsx'
      - '**.tsx'
      - '**.html'
      - 'package*.json'
  
  # Weekly deep scans on Monday at 3 AM UTC
  schedule:
    - cron: '0 3 * * 1'
  
  # Manual trigger for on-demand scanning
  workflow_dispatch:
    inputs:
      output_format:
        description: 'Output format for results'
        required: false
        type: choice
        options:
          - 'markdown'
          - 'json'
          - 'both'
        default: 'markdown'

# Minimal permissions - explicitly NO security-events write to avoid warnings
permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read
  # Explicitly NOT including security-events permission

# Cancel in-progress runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Run CodeQL analysis using CLI directly without Code Scanning API
  analyze:
    name: Analyze Code Security
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    # Step 1: Checkout repository code
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    # Step 2: Setup Node.js for JavaScript/TypeScript analysis
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'  # Matches Angular 19 requirements
        cache: 'npm'

    # Step 3: Download and setup CodeQL CLI directly (avoiding the action that requires API access)
    - name: Setup CodeQL CLI
      run: |
        echo "üì• Downloading CodeQL CLI bundle..."
        # Download the latest CodeQL bundle
        wget -q https://github.com/github/codeql-action/releases/download/codeql-bundle-v2.21.3/codeql-bundle-linux64.tar.gz
        
        # Extract CodeQL
        echo "üì¶ Extracting CodeQL..."
        tar -xzf codeql-bundle-linux64.tar.gz
        
        # Add to PATH
        echo "üîß Adding CodeQL to PATH..."
        echo "$GITHUB_WORKSPACE/codeql" >> $GITHUB_PATH
        
        # Verify installation
        ./codeql/codeql version

    # Step 4: Install dependencies for better analysis accuracy
    - name: Install dependencies
      run: |
        echo "üì¶ Installing JavaScript/TypeScript dependencies for CodeQL analysis..."
        
        # Install root dependencies if package.json exists
        if [ -f "package.json" ]; then
          echo "Installing root dependencies..."
          npm ci --prefer-offline --no-audit || npm install
        fi
        
        # Install frontend dependencies if they exist in a subdirectory
        if [ -f "frontend/package.json" ]; then
          echo "Installing frontend dependencies..."
          cd frontend && npm ci --prefer-offline --no-audit || npm install
          cd ..
        fi
        
        # Install any other Node.js project dependencies
        # TODO: Add additional paths if your project has other package.json locations
        if [ -f "client/package.json" ]; then
          echo "Installing client dependencies..."
          cd client && npm ci --prefer-offline --no-audit || npm install
          cd ..
        fi

    # Step 5: Create CodeQL database manually
    - name: Create CodeQL Database
      run: |
        echo "üóÑÔ∏è Creating CodeQL database for JavaScript/TypeScript..."
        
        # Create database directory
        mkdir -p codeql-dbs
        
        # Create CodeQL database without using the GitHub Action
        ./codeql/codeql database create codeql-dbs/javascript \
          --language=javascript \
          --source-root=. \
          --overwrite \
          --threads=0 \
          --verbosity=progress

    # Step 6: Run CodeQL analysis queries
    - name: Analyze with CodeQL
      run: |
        echo "üîç Running CodeQL security analysis..."
        
        # Create results directory
        mkdir -p codeql-results
        
        # Run analysis with security queries
        ./codeql/codeql database analyze codeql-dbs/javascript \
          --format=sarif-latest \
          --output=codeql-results/javascript.sarif \
          --threads=0 \
          -- ./codeql/qlpacks/codeql/javascript-queries/codeql-suites/javascript-security-and-quality.qls
        
        echo "‚úÖ Analysis complete!"

    # Step 7: Convert CodeQL results to readable format
    # This step processes the SARIF output from CodeQL and converts it to human-readable formats
    # We handle both successful analysis (with SARIF file) and failed analysis (no SARIF file)
    - name: Process CodeQL Results
      id: process-results
      run: |
        echo "üìä Processing CodeQL results for JavaScript/TypeScript..."
        
        # Create directory for processed results
        mkdir -p processed-results
        
        # Define the expected SARIF file location from CodeQL analysis
        SARIF_FILE="codeql-results/javascript.sarif"
        
        # Check if CodeQL successfully generated a SARIF file
        if [ -f "$SARIF_FILE" ]; then
          echo "Found SARIF file: $SARIF_FILE"
          
          # Process SARIF file using Node.js with ESModules syntax
          # The --input-type=module flag enables ESModules in Node.js eval
          node --input-type=module --eval "
          // Import required modules using ESModules syntax
          import { readFileSync, writeFileSync } from 'fs';
          
          // Read the SARIF (Static Analysis Results Interchange Format) file
          const sarifContent = readFileSync('$SARIF_FILE', 'utf8');
          const sarif = JSON.parse(sarifContent);
          
          // Initialize severity counters for summary statistics
          let criticalCount = 0;  // CVSS 9.0-10.0
          let highCount = 0;      // CVSS 7.0-8.9 or error level
          let mediumCount = 0;    // CVSS 4.0-6.9 or warning level
          let lowCount = 0;       // CVSS 0.0-3.9 or note level
          const findings = [];    // Array to store all security findings
          
          // Process each run in the SARIF file (usually one per language/tool)
          for (const run of sarif.runs || []) {
            const tool = run.tool?.driver?.name || 'CodeQL';
            
            // Process each security finding result
            for (const result of run.results || []) {
              // Determine severity based on CodeQL levels and security scores
              const level = result.level || 'warning';
              let severity = 'MEDIUM';
              
              // Check for CVSS-based security severity score (more accurate)
              const securitySeverity = result.properties?.['security-severity'];
              if (securitySeverity !== undefined) {
                // Convert CVSS score to severity level
                // Based on CVSS v3.1 severity ratings
                if (securitySeverity >= 9.0) {
                  severity = 'CRITICAL';
                  criticalCount++;
                } else if (securitySeverity >= 7.0) {
                  severity = 'HIGH';
                  highCount++;
                } else if (securitySeverity >= 4.0) {
                  severity = 'MEDIUM';
                  mediumCount++;
                } else {
                  severity = 'LOW';
                  lowCount++;
                }
              } else {
                // Fall back to basic level-based severity if no CVSS score
                if (level === 'error') {
                  severity = 'HIGH';
                  highCount++;
                } else if (level === 'warning') {
                  severity = 'MEDIUM';
                  mediumCount++;
                } else {
                  severity = 'LOW';
                  lowCount++;
                }
              }
              
              // Extract location information for the finding
              const location = result.locations?.[0]?.physicalLocation;
              const file = location?.artifactLocation?.uri || 'unknown';
              const line = location?.region?.startLine || '?';
              const snippet = location?.region?.snippet?.text || '';
              
              // Add finding to array with all relevant information
              findings.push({
                severity,
                rule: result.ruleId || 'unknown',
                message: result.message?.text || 'No description',
                file,
                line,
                snippet,
                tool
              });
            }
          }
          
          // Sort findings by severity (most severe first)
          const severityOrder = { 'CRITICAL': 0, 'HIGH': 1, 'MEDIUM': 2, 'LOW': 3 };
          findings.sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity]);
          
          // Generate markdown report with proper escaping for shell
          let markdown = '# CodeQL Security Analysis Results\\n\\n';
          markdown += '**Language:** JavaScript/TypeScript\\n';
          markdown += '**Date:** ' + new Date().toISOString() + '\\n';
          markdown += '**Triggered by:** @${{ github.actor }}\\n\\n';
          
          // Add summary table
          markdown += '## üìä Summary\\n\\n';
          markdown += '| Severity | Count |\\n';
          markdown += '|----------|-------|\\n';
          markdown += '| üö® CRITICAL | ' + criticalCount + ' |\\n';
          markdown += '| üî¥ HIGH | ' + highCount + ' |\\n';
          markdown += '| üü° MEDIUM | ' + mediumCount + ' |\\n';
          markdown += '| üîµ LOW | ' + lowCount + ' |\\n';
          markdown += '| **TOTAL** | **' + findings.length + '** |\\n\\n';
          
          // Add detailed findings section if issues were found
          if (findings.length > 0) {
            markdown += '## üîç Detailed Findings\\n\\n';
            
            // Group findings by severity for organized output
            const grouped = findings.reduce((acc, finding) => {
              if (!acc[finding.severity]) acc[finding.severity] = [];
              acc[finding.severity].push(finding);
              return acc;
            }, {});
            
            // Output findings by severity level
            for (const [severity, items] of Object.entries(grouped)) {
              markdown += '### ' + severity + ' Severity Issues\\n\\n';
              
              // Limit to 10 items per severity level for readability
              for (const item of items.slice(0, 10)) {
                markdown += '#### ' + item.rule + '\\n';
                markdown += '- **File:** \`' + item.file + ':' + item.line + '\`\\n';
                markdown += '- **Message:** ' + item.message + '\\n';
                
                // Add code snippet if available
                if (item.snippet) {
                  markdown += '\\n**Code:**\\n';
                  markdown += '\`\`\`javascript\\n';
                  markdown += item.snippet + '\\n';
                  markdown += '\`\`\`\\n';
                }
                
                markdown += '\\n';
              }
              
              // Indicate if there are more findings than shown
              if (items.length > 10) {
                markdown += '*... and ' + (items.length - 10) + ' more ' + severity + ' issues*\\n\\n';
              }
            }
          } else {
            // No issues found - success message
            markdown += '## ‚úÖ No Security Issues Found!\\n\\n';
            markdown += 'Great job! CodeQL analysis found no security vulnerabilities in your JavaScript/TypeScript code.\\n';
          }
          
          // Add recommendations section based on findings
          markdown += '## üí° Recommendations\\n\\n';
          if (criticalCount > 0 || highCount > 0) {
            markdown += '1. **Immediate Action:** Fix all CRITICAL and HIGH severity issues before deployment\\n';
            markdown += '2. Review [CodeQL JavaScript documentation](https://codeql.github.com/docs/codeql-language-guides/codeql-for-javascript/)\\n';
            markdown += '3. Consider adding inline suppressions for false positives:\\n';
            markdown += '   \`\`\`javascript\\n';
            markdown += '   // codeql[js/rule-id] - Explanation why this is safe\\n';
            markdown += '   \`\`\`\\n';
          } else if (mediumCount > 0) {
            markdown += '1. Schedule time to address MEDIUM severity issues\\n';
            markdown += '2. Review security best practices for JavaScript/TypeScript\\n';
            markdown += '3. Keep dependencies updated to latest versions\\n';
          } else {
            markdown += '1. Continue following security best practices\\n';
            markdown += '2. Keep dependencies updated\\n';
            markdown += '3. Regular security scanning is working well!\\n';
          }
          
          // Save markdown report to file
          writeFileSync('processed-results/codeql-javascript-typescript.md', markdown);
          
          // Create JSON report for programmatic access and integrations
          const jsonReport = {
            language: 'javascript-typescript',
            timestamp: new Date().toISOString(),
            triggeredBy: '${{ github.actor }}',
            summary: {
              total: findings.length,
              critical: criticalCount,
              high: highCount,
              medium: mediumCount,
              low: lowCount
            },
            findings: findings.slice(0, 100) // Limit to first 100 for file size
          };
          
          // Save JSON report
          writeFileSync('processed-results/codeql-javascript-typescript.json', JSON.stringify(jsonReport, null, 2));
          
          // Set GitHub Actions outputs for use in subsequent steps
          console.log('::set-output name=total_issues::' + findings.length);
          console.log('::set-output name=critical_issues::' + criticalCount);
          console.log('::set-output name=high_issues::' + highCount);
          console.log('::set-output name=has_issues::' + (findings.length > 0));
          "
        else
          # No SARIF file found - create fallback reports
          echo "No SARIF file found, creating empty report..."
          
          # Capture current date in ISO format for use in heredoc
          # This avoids the syntax error from direct command substitution in heredoc
          CURRENT_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          # Create a minimal markdown report when no SARIF is generated
          # Using heredoc with proper variable substitution
          cat > processed-results/codeql-javascript-typescript.md << EOF
# CodeQL Security Analysis Results

**Date:** $CURRENT_DATE
**Language:** JavaScript/TypeScript

‚ö†Ô∏è No results file generated. This might indicate:
- The analysis is still being configured
- No JavaScript/TypeScript files were found
- An error occurred during analysis

Please check the workflow logs for more details.
EOF
          
          # Create minimal JSON report with proper date
          # This ensures downstream steps have valid JSON even if analysis failed
          cat > processed-results/codeql-javascript-typescript.json << EOF
{
  "language": "javascript-typescript",
  "timestamp": "$CURRENT_DATE",
  "triggeredBy": "${{ github.actor }}",
  "summary": {
    "total": 0,
    "critical": 0,
    "high": 0,
    "medium": 0,
    "low": 0
  },
  "findings": []
}
EOF
          
          # Set safe default outputs for GitHub Actions
          # These prevent errors in subsequent steps that depend on these outputs
          echo "::set-output name=total_issues::0"
          echo "::set-output name=critical_issues::0"
          echo "::set-output name=high_issues::0"
          echo "::set-output name=has_issues::false"
        fi

    # Step 8: Upload results as artifacts (accessible without Advanced Security)
    - name: Upload CodeQL Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: codeql-results-javascript-typescript
        path: |
          codeql-results/
          processed-results/
        retention-days: 30

    # Step 9: Upload raw database for advanced users
    - name: Upload CodeQL Database
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: codeql-database
        path: codeql-dbs/
        retention-days: 7

    # Step 10: Add results to job summary
    - name: Add to Job Summary
      if: always()
      run: |
        echo "## üîê CodeQL Analysis Results for JavaScript/TypeScript" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow run by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "processed-results/codeql-javascript-typescript.md" ]; then
          # Add the generated report to the summary
          cat "processed-results/codeql-javascript-typescript.md" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ö†Ô∏è No results file found. Check the workflow logs for errors." >> $GITHUB_STEP_SUMMARY
        fi
        
        # Add links to artifacts
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üì• Downloads" >> $GITHUB_STEP_SUMMARY
        echo "- [Download Full Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "- Look for \`codeql-results-javascript-typescript\` artifact" >> $GITHUB_STEP_SUMMARY

    # Step 11: Comment on PR with results (if applicable)
    - name: Comment on Pull Request
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          // Import fs module for file reading using require (CommonJS in actions/github-script)
          const fs = require('fs');
          
          // Initialize comment content
          let reportContent = '## üîê CodeQL Security Analysis Results\n\n';
          reportContent += '**Language:** JavaScript/TypeScript only (No Python scanning)\n';
          reportContent += '**Analyzed by:** CodeQL CLI (Pro+ Compatible Mode)\n\n';
          
          // Try to read the results from the JSON report
          let totalIssues = '0';
          let criticalIssues = '0';
          let highIssues = '0';
          let hasResults = false;
          
          try {
            if (fs.existsSync('processed-results/codeql-javascript-typescript.json')) {
              const jsonContent = fs.readFileSync('processed-results/codeql-javascript-typescript.json', 'utf8');
              const results = JSON.parse(jsonContent);
              totalIssues = results.summary.total.toString();
              criticalIssues = results.summary.critical.toString();
              highIssues = results.summary.high.toString();
              hasResults = true;
            }
          } catch (error) {
            console.log('Could not read results file:', error);
          }
          
          // Add summary metrics
          reportContent += `### üìä Summary\n\n`;
          reportContent += `| Metric | Value |\n`;
          reportContent += `|--------|-------|\n`;
          reportContent += `| **Total Issues Found** | ${totalIssues} |\n`;
          reportContent += `| **Critical Severity Issues** | ${criticalIssues} |\n`;
          reportContent += `| **High Severity Issues** | ${highIssues} |\n\n`;
          
          // Calculate total high priority issues (critical + high)
          const highPriorityIssues = parseInt(criticalIssues) + parseInt(highIssues);
          
          // Add status based on findings
          if (!hasResults) {
            reportContent += '‚ö†Ô∏è **Status:** Analysis may have encountered issues\n\n';
          } else if (highPriorityIssues > 0) {
            reportContent += '‚ö†Ô∏è **Status:** Security issues detected that need attention\n\n';
            reportContent += '### üö® Action Required\n';
            reportContent += `This PR contains ${highPriorityIssues} critical/high severity security issues. `;
            reportContent += 'Please address them before merging.\n\n';
          } else if (parseInt(totalIssues) > 0) {
            reportContent += '‚ö° **Status:** Minor security issues detected\n\n';
            reportContent += '### üí° Recommendations\n';
            reportContent += 'Consider addressing the security findings when possible.\n\n';
          } else {
            reportContent += '‚úÖ **Status:** No security issues found!\n\n';
            reportContent += 'Your JavaScript/TypeScript code passed all security checks. Great job! üéâ\n\n';
          }
          
          // Add links and instructions
          reportContent += `### üìÑ Full Report\n\n`;
          reportContent += `- [View workflow run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n`;
          reportContent += `- Download the \`codeql-results-javascript-typescript\` artifact for detailed findings\n`;
          reportContent += `- Raw database available in \`codeql-database\` artifact for custom queries\n\n`;
          
          // Add next steps
          reportContent += '### üìã Next Steps\n\n';
          if (parseInt(totalIssues) > 0) {
            reportContent += '1. Download the security report artifact\n';
            reportContent += '2. Review each finding in detail\n';
            reportContent += '3. Fix legitimate security vulnerabilities\n';
            reportContent += '4. Add suppressions for false positives using:\n';
            reportContent += '   ```javascript\n';
            reportContent += '   // codeql[js/rule-id] - Reason for suppression\n';
            reportContent += '   ```\n';
            reportContent += '5. Re-run the analysis after making changes\n';
          } else {
            reportContent += '1. Continue following security best practices\n';
            reportContent += '2. Keep your dependencies up to date\n';
            reportContent += '3. Monitor for new security patterns\n';
          }
          
          // Add troubleshooting section
          reportContent += '\n### üîß Troubleshooting\n\n';
          reportContent += 'If you see warnings about Code Scanning API:\n';
          reportContent += '- These can be safely ignored (Pro+ limitation)\n';
          reportContent += '- Results are still generated and available as artifacts\n';
          reportContent += '- This workflow uses CodeQL CLI directly to avoid API dependencies\n';
          
          // Add footer with metadata
          reportContent += '\n---\n';
          reportContent += `<sub>ü§ñ Generated by CodeQL Security Workflow (Pro+ Edition)</sub><br>`;
          reportContent += `<sub>üìÖ ${new Date().toISOString()}</sub><br>`;
          reportContent += `<sub>üîß JavaScript/TypeScript analysis only - Python scanning disabled</sub><br>`;
          reportContent += `<sub>‚ö° Using CodeQL CLI directly to avoid API limitations</sub>`;
          
          // Find and update or create comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          // Look for existing CodeQL comment
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('CodeQL Security Analysis Results')
          );
          
          if (botComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: reportContent,
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reportContent,
            });
          }

    # Step 12: Optional - Fail the workflow if critical/high severity issues found
    - name: Check Security Status
      if: github.event_name == 'pull_request'
      run: |
        # Read the critical and high issues count from the previous step
        CRITICAL_ISSUES="${{ steps.process-results.outputs.critical_issues }}"
        HIGH_ISSUES="${{ steps.process-results.outputs.high_issues }}"
        TOTAL_HIGH_PRIORITY=$((CRITICAL_ISSUES + HIGH_ISSUES))
        
        if [ "$TOTAL_HIGH_PRIORITY" -gt "0" ]; then
          echo "‚ùå Found $CRITICAL_ISSUES critical and $HIGH_ISSUES high severity security issues!"
          echo "Please review the security report and fix the issues before merging."
          # TODO: Uncomment the next line to enforce security checks on PRs
          # exit 1
        else
          echo "‚úÖ Security check passed! No critical or high severity issues found."
        fi
