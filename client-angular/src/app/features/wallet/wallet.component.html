<div class="wallet-container">
  <div class="wallet-header">
    <h1 class="wallet-title">My Wallet</h1>
    <div class="wallet-actions">
      <button mat-raised-button color="primary" (click)="openDepositDialog()" [disabled]="loading.wallet">
        <mat-icon>add</mat-icon> Deposit
      </button>
      <button mat-raised-button color="accent" (click)="openWithdrawDialog()" [disabled]="loading.wallet">
        <mat-icon>remove</mat-icon> Withdraw
      </button>
      <button mat-raised-button color="basic" (click)="openTransferDialog()" [disabled]="loading.wallet">
        <mat-icon>swap_horiz</mat-icon> Transfer
      </button>
    </div>
  </div>

  <!-- Loading spinner -->
  <div class="loading-container" *ngIf="loading.wallet">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Loading wallet data...</p>
  </div>

  <!-- Wallet content -->
  <div class="wallet-content" *ngIf="!loading.wallet">
    <!-- Balance overview -->
    <div class="balance-overview">
      <mat-card class="total-balance-card">
        <mat-card-header>
          <mat-card-title>Total Balance</mat-card-title>
          <mat-card-subtitle>Available funds</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <h2 class="total-balance">{{ getTotalBalance() }}</h2>
        </mat-card-content>
      </mat-card>

      <!-- Individual balances -->
      <div class="currency-balances">
        <mat-card *ngFor="let balance of balances" class="currency-balance-card">
          <mat-card-header>
            <mat-card-title>{{ balance.currency }}</mat-card-title>
            <mat-card-subtitle>
              <span *ngIf="balance.pending > 0">{{ walletService.formatCurrency(balance.pending, balance.currency) }} pending</span>
            </mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <h3>{{ walletService.formatCurrency(balance.available, balance.currency) }}</h3>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <!-- Tabs for different wallet sections -->
    <mat-tab-group animationDuration="0ms" class="wallet-tabs">
      <!-- Transactions tab -->
      <mat-tab label="Transactions">
        <div class="transactions-container">
          <!-- Filters -->
          <div class="transactions-filters">
            <mat-form-field appearance="outline">
              <mat-label>Type</mat-label>
              <mat-select [(ngModel)]="transactionFilters.type" (selectionChange)="applyFilters()">
                <mat-option *ngFor="let type of transactionTypes" [value]="type.value">
                  {{ type.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Status</mat-label>
              <mat-select [(ngModel)]="transactionFilters.status" (selectionChange)="applyFilters()">
                <mat-option *ngFor="let status of transactionStatuses" [value]="status.value">
                  {{ status.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Currency</mat-label>
              <mat-select [(ngModel)]="transactionFilters.currency" (selectionChange)="applyFilters()">
                <mat-option value="">All Currencies</mat-option>
                <mat-option *ngFor="let balance of balances" [value]="balance.currency">
                  {{ balance.currency }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <button mat-button color="primary" (click)="resetFilters()">
              <mat-icon>clear</mat-icon> Clear Filters
            </button>
          </div>

          <!-- Transactions table -->
          <div class="transactions-table-container">
            <div class="loading-overlay" *ngIf="loading.transactions">
              <mat-spinner diameter="30"></mat-spinner>
            </div>

            <table mat-table [dataSource]="transactions" class="transactions-table">
              <!-- Date Column -->
              <ng-container matColumnDef="date">
                <th mat-header-cell *matHeaderCellDef>Date</th>
                <td mat-cell *matCellDef="let transaction">
                  {{ transaction.createdAt | date:'medium' }}
                </td>
              </ng-container>

              <!-- Type Column -->
              <ng-container matColumnDef="type">
                <th mat-header-cell *matHeaderCellDef>Type</th>
                <td mat-cell *matCellDef="let transaction">
                  <span class="transaction-type" [ngClass]="getTransactionTypeClass(transaction.type)">
                    {{ transaction.type | titlecase }}
                  </span>
                </td>
              </ng-container>

              <!-- Amount Column -->
              <ng-container matColumnDef="amount">
                <th mat-header-cell *matHeaderCellDef>Amount</th>
                <td mat-cell *matCellDef="let transaction">
                  <span [ngClass]="{'positive-amount': transaction.amount > 0, 'negative-amount': transaction.amount < 0}">
                    {{ formatTransactionAmount(transaction) }}
                  </span>
                </td>
              </ng-container>

              <!-- Status Column -->
              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>Status</th>
                <td mat-cell *matCellDef="let transaction">
                  <span class="transaction-status" [ngClass]="getTransactionStatusClass(transaction.status)">
                    {{ transaction.status | titlecase }}
                  </span>
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let transaction">
                  <button mat-icon-button color="primary" (click)="openTransactionDetailsDialog(transaction)" matTooltip="View Details">
                    <mat-icon>info</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>

            <!-- No transactions message -->
            <div class="no-data-message" *ngIf="!loading.transactions && transactions.length === 0">
              <mat-icon>account_balance_wallet</mat-icon>
              <p>No transactions found</p>
              <button mat-raised-button color="primary" (click)="openDepositDialog()">
                Make Your First Deposit
              </button>
            </div>

            <!-- Pagination -->
            <div class="pagination-container" *ngIf="totalPages > 1">
              <emerald-pager
                [currentPage]="currentPage"
                [totalPages]="totalPages"
                [showPageSize]="true"
                [pageSize]="pageSize"
                [pageSizes]="[10, 20, 50, 100]"
                style="default"
                size="medium"
                align="center"
                (pageChange)="onPageChange($event)"
                (pageSizeChange)="onPageSizeChange($event)">
              </emerald-pager>
            </div>
          </div>
        </div>
      </mat-tab>

      <!-- Payment Methods tab -->
      <mat-tab label="Payment Methods">
        <div class="payment-methods-container">
          <div class="payment-methods-header">
            <h2>Payment Methods</h2>
            <button mat-raised-button color="primary" (click)="openAddPaymentMethodDialog()">
              <mat-icon>add</mat-icon> Add Payment Method
            </button>
          </div>

          <!-- Loading spinner -->
          <div class="loading-container" *ngIf="loading.paymentMethods">
            <mat-spinner diameter="30"></mat-spinner>
            <p>Loading payment methods...</p>
          </div>

          <!-- Payment methods list -->
          <div class="payment-methods-list" *ngIf="!loading.paymentMethods">
            <!-- No payment methods message -->
            <div class="no-data-message" *ngIf="paymentMethods.length === 0">
              <mat-icon>credit_card</mat-icon>
              <p>No payment methods found</p>
              <button mat-raised-button color="primary" (click)="openAddPaymentMethodDialog()">
                Add Payment Method
              </button>
            </div>

            <!-- Payment methods cards -->
            <mat-card *ngFor="let method of paymentMethods" class="payment-method-card">
              <mat-card-header>
                <mat-icon mat-card-avatar>{{ getPaymentMethodIcon(method) }}</mat-icon>
                <mat-card-title>{{ getPaymentMethodDisplayName(method) }}</mat-card-title>
                <mat-card-subtitle>
                  {{ method.type | titlecase }}
                  <span *ngIf="method.isDefault" class="default-badge">Default</span>
                </mat-card-subtitle>
              </mat-card-header>

              <mat-card-content>
                <!-- Card details -->
                <div *ngIf="method.type === 'card' && method.cardDetails">
                  <p>Expires: {{ method.cardDetails.expiryMonth }}/{{ method.cardDetails.expiryYear }}</p>
                </div>

                <!-- Bank account details -->
                <div *ngIf="method.type === 'bank_account' && method.bankDetails">
                  <p>{{ method.bankDetails.accountType }} - {{ method.bankDetails.country }}</p>
                </div>

                <!-- Crypto address details -->
                <div *ngIf="method.type === 'crypto_address' && method.cryptoDetails">
                  <p class="crypto-address">
                    {{ method.cryptoDetails.address | slice:0:10 }}...{{ method.cryptoDetails.address | slice:-10 }}
                    <button mat-icon-button [cdkCopyToClipboard]="method.cryptoDetails.address" matTooltip="Copy Address">
                      <mat-icon>content_copy</mat-icon>
                    </button>
                  </p>
                  <p>Network: {{ method.cryptoDetails.network }}</p>
                  <div *ngIf="method.cryptoDetails.memo">
                    <p>Memo: {{ method.cryptoDetails.memo }}</p>
                  </div>
                </div>
              </mat-card-content>

              <mat-card-actions align="end">
                <button mat-button color="warn" (click)="removePaymentMethod(method._id)">
                  <mat-icon>delete</mat-icon> Remove
                </button>
                <button mat-button color="primary" (click)="setDefaultPaymentMethod(method._id)" [disabled]="method.isDefault">
                  <mat-icon>star</mat-icon> Set as Default
                </button>
              </mat-card-actions>
            </mat-card>
          </div>
        </div>
      </mat-tab>

      <!-- Settings tab -->
      <mat-tab label="Settings">
        <div class="settings-container">
          <h2>Wallet Settings</h2>

          <form [formGroup]="settingsForm" (ngSubmit)="saveSettings()">
            <!-- Default Currency -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Default Currency</mat-label>
              <mat-select formControlName="defaultCurrency">
                <mat-option *ngFor="let currency of walletService.SUPPORTED_CURRENCIES" [value]="currency">
                  {{ currency }}
                </mat-option>
                <mat-option *ngFor="let currency of walletService.SUPPORTED_CRYPTOCURRENCIES" [value]="currency">
                  {{ currency }}
                </mat-option>
              </mat-select>
              <mat-hint>This currency will be used as the default for all transactions</mat-hint>
            </mat-form-field>

            <!-- Auto Withdrawal Settings -->
            <div formGroupName="autoWithdrawal" class="settings-section">
              <h3>Automatic Withdrawal</h3>
              
              <mat-slide-toggle formControlName="enabled" color="primary">
                Enable Automatic Withdrawal
              </mat-slide-toggle>
              
              <div *ngIf="settingsForm.get('autoWithdrawal.enabled')?.value">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Threshold Amount (NOK)</mat-label>
                  <input matInput type="number" formControlName="threshold" min="10000">
                  <mat-hint>Withdrawal will be triggered when your balance exceeds this amount</mat-hint>
                  <mat-error *ngIf="settingsForm.get('autoWithdrawal.threshold')?.hasError('min')">
                    Minimum threshold is 100 NOK
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Payment Method</mat-label>
                  <mat-select formControlName="paymentMethodId">
                    <mat-option *ngFor="let method of paymentMethods" [value]="method._id">
                      {{ getPaymentMethodDisplayName(method) }}
                    </mat-option>
                  </mat-select>
                  <mat-hint>Select the payment method to use for automatic withdrawals</mat-hint>
                </mat-form-field>
              </div>
            </div>

            <!-- Notification Preferences -->
            <div formGroupName="notificationPreferences" class="settings-section">
              <h3>Notification Preferences</h3>
              
              <div formGroupName="email" class="notification-group">
                <h4>Email Notifications</h4>
                
                <mat-checkbox formControlName="deposit" color="primary">
                  Deposits
                </mat-checkbox>
                
                <mat-checkbox formControlName="withdrawal" color="primary">
                  Withdrawals
                </mat-checkbox>
                
                <mat-checkbox formControlName="payment" color="primary">
                  Payments
                </mat-checkbox>
              </div>
              
              <div formGroupName="push" class="notification-group">
                <h4>Push Notifications</h4>
                
                <mat-checkbox formControlName="deposit" color="primary">
                  Deposits
                </mat-checkbox>
                
                <mat-checkbox formControlName="withdrawal" color="primary">
                  Withdrawals
                </mat-checkbox>
                
                <mat-checkbox formControlName="payment" color="primary">
                  Payments
                </mat-checkbox>
              </div>
            </div>

            <div class="form-actions">
              <button mat-raised-button color="primary" type="submit" [disabled]="settingsForm.invalid">
                Save Settings
              </button>
            </div>
          </form>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>
</div>

<!-- Floating action button for quick actions -->
<emerald-floating-action-button
  icon="account_balance_wallet"
  position="bottom-right"
  color="primary"
  [menuItems]="[
    { icon: 'add', label: 'Deposit', action: openDepositDialog.bind(this) },
    { icon: 'remove', label: 'Withdraw', action: openWithdrawDialog.bind(this) },
    { icon: 'swap_horiz', label: 'Transfer', action: openTransferDialog.bind(this) }
  ]">
</emerald-floating-action-button>