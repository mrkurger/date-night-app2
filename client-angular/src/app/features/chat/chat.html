
      <!doctype html>
      <html lang="en">
        <head>
          <meta charset="UTF-8" />
          <meta name="viewport" content="width=device-width, initial-scale=1.0" />
          <title>Chat - Date Night App</title>
          <link rel="stylesheet" href="/docs/component-library/styles/style.css" />
          <style>
            .tooltip {
              position: relative;
              display: inline-block;
              border-bottom: 1px dotted #333;
            }
            .tooltip .tooltip-text {
              visibility: hidden;
              width: 300px;
              background-color: #f8f9fa;
              color: #333;
              text-align: left;
              border-radius: 6px;
              padding: 10px;
              position: absolute;
              z-index: 1;
              bottom: 125%;
              left: 50%;
              margin-left: -150px;
              opacity: 0;
              transition: opacity 0.3s;
              box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            }
            .tooltip:hover .tooltip-text {
              visibility: visible;
              opacity: 1;
            }
            .function-link {
              color: #0366d6;
              text-decoration: none;
              font-family: monospace;
              background-color: #f6f8fa;
              padding: 2px 4px;
              border-radius: 3px;
            }
            .function-link:hover {
              text-decoration: underline;
            }
            code {
              font-family: monospace;
              background-color: #f6f8fa;
              padding: 2px 4px;
              border-radius: 3px;
            }
            pre {
              background-color: #f6f8fa;
              padding: 16px;
              border-radius: 6px;
              overflow: auto;
            }
          </style>
        </head>
        <body>
          <header>
            <div class="container">
              <h1>Date Night App Documentation</h1>
              <nav>
                <ul>
                  <li><a href="/_docs_index.html">Home</a></li>
                  <li><a href="/_glossary.html">Glossary</a></li>
                  <li><a href="index.html">chat Index</a></li>
                </ul>
              </nav>
            </div>
          </header>
          <main class="container">
            <div class="page-content">
              
    <aside class="sidebar">
      <h3>Chat</h3>
      <ul>
        <li><a href="./CHANGELOG.html">Changelog</a></li>
        <li><a href="./AILESSONS.html">AI Lessons</a></li>
        <li><a href="./GLOSSARY.html">Glossary</a></li>
        <li><a href="./chat.html">Chat</a></li>
      </ul>
  
    </aside>
  
              <article class="content">
                <h1>Chat</h1>
                
      <section id="overview">
        <h2>Overview</h2>
        <h2>Overview</h2>
<p>The Chat System is a core feature of DateNight.io that enables real-time communication between users. It supports one-on-one conversations, message history, read receipts, typing indicators, and end-to-end encryption for secure communication.</p>
<h2>User Experience</h2>
<p>Users interact with the Chat System through several interfaces:</p>
<ul>
<li><strong>Chat List</strong>: Displays all conversations with preview of the latest message</li>
<li><strong>Conversation View</strong>: Shows the full message history with a specific user</li>
<li><strong>Message Composer</strong>: Allows users to type and send messages</li>
<li><strong>Notifications</strong>: Alerts users of new messages via in-app and push notifications</li>
<li><strong>Chat Settings</strong>: Allows users to manage notification preferences, block users, and clear history</li>
</ul>
<h2>Architecture</h2>
<h3>Client-Side Components</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Path</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>ChatModule</code></td>
<td><code>/client-angular/src/app/features/chat/chat.module.ts</code></td>
<td>Main module for chat feature</td>
</tr>
<tr>
<td><code>ChatListComponent</code></td>
<td><code>/client-angular/src/app/features/chat/components/chat-list/chat-list.component.ts</code></td>
<td>Displays list of conversations</td>
</tr>
<tr>
<td><code>ConversationComponent</code></td>
<td><code>/client-angular/src/app/features/chat/components/conversation/conversation.component.ts</code></td>
<td>Displays message history with a user</td>
</tr>
<tr>
<td><code>MessageComponent</code></td>
<td><code>/client-angular/src/app/features/chat/components/message/message.component.ts</code></td>
<td>Renders individual message</td>
</tr>
<tr>
<td><code>ComposerComponent</code></td>
<td><code>/client-angular/src/app/features/chat/components/composer/composer.component.ts</code></td>
<td>Message input and sending interface</td>
</tr>
<tr>
<td><code>ChatSettingsComponent</code></td>
<td><code>/client-angular/src/app/features/chat/components/chat-settings/chat-settings.component.ts</code></td>
<td>Chat preferences and settings</td>
</tr>
<tr>
<td><code>TypingIndicatorComponent</code></td>
<td><code>/client-angular/src/app/features/chat/components/typing-indicator/typing-indicator.component.ts</code></td>
<td>Shows when someone is typing</td>
</tr>
<tr>
<td><code>ChatNotificationComponent</code></td>
<td><code>/client-angular/src/app/features/chat/components/chat-notification/chat-notification.component.ts</code></td>
<td>In-app notification for new messages</td>
</tr>
</tbody></table>
<h3>Client-Side Services</h3>
<table>
<thead>
<tr>
<th>Service</th>
<th>Path</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>ChatService</code></td>
<td><code>/client-angular/src/app/core/services/chat.service.ts</code></td>
<td>Manages chat data and operations</td>
</tr>
<tr>
<td><code>SocketService</code></td>
<td><code>/client-angular/src/app/core/services/socket.service.ts</code></td>
<td>Handles WebSocket connections</td>
</tr>
<tr>
<td><code>MessageService</code></td>
<td><code>/client-angular/src/app/core/services/message.service.ts</code></td>
<td>Handles message operations</td>
</tr>
<tr>
<td><code>EncryptionService</code></td>
<td><code>/client-angular/src/app/core/services/encryption.service.ts</code></td>
<td>Handles E2E encryption</td>
</tr>
<tr>
<td><code>NotificationService</code></td>
<td><code>/client-angular/src/app/core/services/notification.service.ts</code></td>
<td>Manages chat notifications</td>
</tr>
</tbody></table>
<h3>Server-Side Controllers</h3>
<table>
<thead>
<tr>
<th>Controller</th>
<th>Path</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>ChatController</code></td>
<td><code>/server/components/chat/chat.controller.js</code></td>
<td>Handles chat-related HTTP requests</td>
</tr>
<tr>
<td><code>MessageController</code></td>
<td><code>/server/components/message/message.controller.js</code></td>
<td>Handles message-related HTTP requests</td>
</tr>
<tr>
<td><code>SocketController</code></td>
<td><code>/server/components/socket/socket.controller.js</code></td>
<td>Handles WebSocket events</td>
</tr>
</tbody></table>
<h3>Server-Side Services</h3>
<table>
<thead>
<tr>
<th>Service</th>
<th>Path</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>ChatService</code></td>
<td><code>/server/services/chat.service.js</code></td>
<td>Implements chat business logic</td>
</tr>
<tr>
<td><code>MessageService</code></td>
<td><code>/server/services/message.service.js</code></td>
<td>Implements message business logic</td>
</tr>
<tr>
<td><code>SocketService</code></td>
<td><code>/server/services/socket.service.js</code></td>
<td>Manages WebSocket connections and events</td>
</tr>
<tr>
<td><code>NotificationService</code></td>
<td><code>/server/services/notification.service.js</code></td>
<td>Sends push notifications</td>
</tr>
</tbody></table>
<h3>Models</h3>
<table>
<thead>
<tr>
<th>Model</th>
<th>Path</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>Chat</code></td>
<td><code>/server/components/chat/chat.model.js</code></td>
<td>Mongoose schema for chat conversations</td>
</tr>
<tr>
<td><code>Message</code></td>
<td><code>/server/components/message/message.model.js</code></td>
<td>Mongoose schema for individual messages</td>
</tr>
<tr>
<td><code>ReadReceipt</code></td>
<td><code>/server/components/message/read-receipt.model.js</code></td>
<td>Mongoose schema for read receipts</td>
</tr>
</tbody></table>

      </section>
    

      <section id="api">
        <h2>API Reference</h2>
        <h2>API Endpoints</h2>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>Method</th>
<th>Description</th>
<th>Request Body</th>
<th>Response</th>
</tr>
</thead>
<tbody><tr>
<td><code>/api/chats</code></td>
<td>GET</td>
<td>Get all user conversations</td>
<td>N/A</td>
<td>Array of chat objects</td>
</tr>
<tr>
<td><code>/api/chats/:chatId</code></td>
<td>GET</td>
<td>Get a specific conversation</td>
<td>N/A</td>
<td>Chat object with messages</td>
</tr>
<tr>
<td><code>/api/chats</code></td>
<td>POST</td>
<td>Create a new conversation</td>
<td><code>{recipientId}</code></td>
<td>Created chat object</td>
</tr>
<tr>
<td><code>/api/chats/:chatId/messages</code></td>
<td>GET</td>
<td>Get messages for a conversation</td>
<td>N/A</td>
<td>Array of message objects</td>
</tr>
<tr>
<td><code>/api/chats/:chatId/messages</code></td>
<td>POST</td>
<td>Send a message</td>
<td><code>{content, attachments}</code></td>
<td>Created message object</td>
</tr>
<tr>
<td><code>/api/chats/:chatId/typing</code></td>
<td>POST</td>
<td>Send typing indicator</td>
<td><code>{isTyping}</code></td>
<td>Success message</td>
</tr>
<tr>
<td><code>/api/chats/:chatId/read</code></td>
<td>POST</td>
<td>Mark messages as read</td>
<td><code>{lastReadMessageId}</code></td>
<td>Updated read receipt</td>
</tr>
<tr>
<td><code>/api/chats/:chatId/settings</code></td>
<td>GET</td>
<td>Get chat settings</td>
<td>N/A</td>
<td>Chat settings object</td>
</tr>
<tr>
<td><code>/api/chats/:chatId/settings</code></td>
<td>PUT</td>
<td>Update chat settings</td>
<td>Settings object</td>
<td>Updated settings object</td>
</tr>
<tr>
<td><code>/api/chats/:chatId</code></td>
<td>DELETE</td>
<td>Delete a conversation</td>
<td>N/A</td>
<td>Success message</td>
</tr>
<tr>
<td><code>/api/messages/:messageId</code></td>
<td>PUT</td>
<td>Edit a message</td>
<td><code>{content}</code></td>
<td>Updated message object</td>
</tr>
<tr>
<td><code>/api/messages/:messageId</code></td>
<td>DELETE</td>
<td>Delete a message</td>
<td>N/A</td>
<td>Success message</td>
</tr>
<tr>
<td><code>/api/users/:userId/block</code></td>
<td>POST</td>
<td>Block a user from chatting</td>
<td>N/A</td>
<td>Success message</td>
</tr>
<tr>
<td><code>/api/users/:userId/unblock</code></td>
<td>POST</td>
<td>Unblock a user</td>
<td>N/A</td>
<td>Success message</td>
</tr>
</tbody></table>
<h2>WebSocket Events</h2>
<table>
<thead>
<tr>
<th>Event</th>
<th>Direction</th>
<th>Description</th>
<th>Payload</th>
</tr>
</thead>
<tbody><tr>
<td><code>join_chat</code></td>
<td>Client → Server</td>
<td>Join a chat room</td>
<td><code>{chatId}</code></td>
</tr>
<tr>
<td><code>leave_chat</code></td>
<td>Client → Server</td>
<td>Leave a chat room</td>
<td><code>{chatId}</code></td>
</tr>
<tr>
<td><code>new_message</code></td>
<td>Server → Client</td>
<td>New message received</td>
<td>Message object</td>
</tr>
<tr>
<td><code>message_sent</code></td>
<td>Server → Client</td>
<td>Confirmation message was sent</td>
<td><code>{messageId, status}</code></td>
</tr>
<tr>
<td><code>message_delivered</code></td>
<td>Server → Client</td>
<td>Message was delivered to recipient</td>
<td><code>{messageId, deliveredAt}</code></td>
</tr>
<tr>
<td><code>message_read</code></td>
<td>Server → Client</td>
<td>Message was read by recipient</td>
<td><code>{messageId, readAt}</code></td>
</tr>
<tr>
<td><code>typing_start</code></td>
<td>Both ways</td>
<td>User started typing</td>
<td><code>{chatId, userId}</code></td>
</tr>
<tr>
<td><code>typing_stop</code></td>
<td>Both ways</td>
<td>User stopped typing</td>
<td><code>{chatId, userId}</code></td>
</tr>
<tr>
<td><code>user_online</code></td>
<td>Server → Client</td>
<td>User came online</td>
<td><code>{userId, lastSeen}</code></td>
</tr>
<tr>
<td><code>user_offline</code></td>
<td>Server → Client</td>
<td>User went offline</td>
<td><code>{userId, lastSeen}</code></td>
</tr>
<tr>
<td><code>message_edited</code></td>
<td>Server → Client</td>
<td>Message was edited</td>
<td>Updated message object</td>
</tr>
<tr>
<td><code>message_deleted</code></td>
<td>Server → Client</td>
<td>Message was deleted</td>
<td><code>{messageId, chatId}</code></td>
</tr>
</tbody></table>
<h2>Data Flow</h2>
<p>The chat system follows these data flows:</p>
<ol>
<li><p><strong>Conversation Initialization</strong>:</p>
<ul>
<li>User navigates to chat list or initiates chat with another user</li>
<li>ChatService loads existing conversations from the server</li>
<li>SocketService establishes WebSocket connection</li>
<li>User joins individual chat rooms for active conversations</li>
<li>Chat list is displayed with conversation previews</li>
</ul>
</li>
<li><p><strong>Sending a Message</strong>:</p>
<ul>
<li>User types message in ComposerComponent</li>
<li>Typing indicator is sent via WebSocket</li>
<li>User sends message</li>
<li>Message is encrypted client-side if E2E is enabled</li>
<li>ChatService sends message to server via HTTP POST</li>
<li>Server stores message in database</li>
<li>Server broadcasts message to recipient via WebSocket</li>
<li>UI updates to show sent message with pending status</li>
</ul>
</li>
<li><p><strong>Receiving a Message</strong>:</p>
<ul>
<li>Server sends message to recipient via WebSocket</li>
<li>SocketService receives the message event</li>
<li>Message is decrypted if E2E is enabled</li>
<li>ChatService adds message to conversation</li>
<li>UI updates to show new message</li>
<li>Read receipt is sent if conversation is currently open</li>
<li>Notification is shown if conversation is not active</li>
</ul>
</li>
<li><p><strong>Read Receipts</strong>:</p>
<ul>
<li>When user opens a conversation, ChatService sends read receipt</li>
<li>Server updates read status for all messages</li>
<li>Server broadcasts read receipt to sender via WebSocket</li>
<li>Sender&#39;s UI updates to show messages as read</li>
</ul>
</li>
</ol>
<h2>State Management</h2>
<p>The chat system uses a combination of service-based state management and WebSocket events:</p>
<ul>
<li><strong>ChatService</strong>: Maintains the current state of all conversations and messages</li>
<li><strong>SocketService</strong>: Handles real-time updates via WebSocket</li>
<li><strong>LocalStorage</strong>: Caches recent conversations and messages for offline access</li>
<li><strong>IndexedDB</strong>: Stores message history and encryption keys for E2E encryption</li>
</ul>
<h2>Key Algorithms and Logic</h2>
<ol>
<li><p><strong>Message Synchronization</strong>:</p>
<ul>
<li>Optimistic UI updates with local message storage</li>
<li>Server reconciliation for conflict resolution</li>
<li>Pagination with cursor-based approach for message history</li>
<li>Background sync for offline messages</li>
</ul>
</li>
<li><p><strong>End-to-End Encryption</strong>:</p>
<ul>
<li>Key generation using the Web Crypto API</li>
<li>Key exchange using RSA for initial handshake</li>
<li>Message encryption using AES-GCM for performance</li>
<li>Key rotation policies for enhanced security</li>
</ul>
</li>
<li><p><strong>Presence Detection</strong>:</p>
<ul>
<li>Heartbeat mechanism for online status</li>
<li>Debounced typing indicators to reduce network traffic</li>
<li>Last seen timestamp updates with privacy controls</li>
<li>Connection state management with reconnection logic</li>
</ul>
</li>
<li><p><strong>Notification Management</strong>:</p>
<ul>
<li>Priority-based notification filtering</li>
<li>User preference-based delivery (push, in-app, email)</li>
<li>Batching for high-volume conversations</li>
<li>Silent notifications for background sync</li>
</ul>
</li>
</ol>
<h2>Security Considerations</h2>
<ol>
<li><p><strong>Message Security</strong>:</p>
<ul>
<li>End-to-end encryption for all messages</li>
<li>Perfect forward secrecy with key rotation</li>
<li>Secure key storage in IndexedDB</li>
<li>Message expiration options for sensitive content</li>
</ul>
</li>
<li><p><strong>Authentication &amp; Authorization</strong>:</p>
<ul>
<li>JWT-based authentication for API requests</li>
<li>Socket authentication with secure tokens</li>
<li>Per-conversation access control</li>
<li>Rate limiting to prevent abuse</li>
</ul>
</li>
<li><p><strong>Privacy Protection</strong>:</p>
<ul>
<li>Configurable read receipts and typing indicators</li>
<li>User blocking capabilities</li>
<li>Message retention policies</li>
<li>Data minimization in transit and storage</li>
</ul>
</li>
</ol>
<h2>Testing</h2>
<h3>Unit Tests</h3>
<table>
<thead>
<tr>
<th>Test File</th>
<th>Path</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>chat.service.spec.ts</code></td>
<td><code>/client-angular/src/app/core/services/chat.service.spec.ts</code></td>
<td>Tests for chat service</td>
</tr>
<tr>
<td><code>socket.service.spec.ts</code></td>
<td><code>/client-angular/src/app/core/services/socket.service.spec.ts</code></td>
<td>Tests for socket service</td>
</tr>
<tr>
<td><code>conversation.component.spec.ts</code></td>
<td><code>/client-angular/src/app/features/chat/components/conversation/conversation.component.spec.ts</code></td>
<td>Tests for conversation component</td>
</tr>
</tbody></table>
<h3>Integration Tests</h3>
<table>
<thead>
<tr>
<th>Test File</th>
<th>Path</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>chat.controller.test.js</code></td>
<td><code>/server/tests/integration/chat/chat.controller.test.js</code></td>
<td>API integration tests</td>
</tr>
<tr>
<td><code>socket.service.test.js</code></td>
<td><code>/server/tests/integration/chat/socket.service.test.js</code></td>
<td>WebSocket integration tests</td>
</tr>
</tbody></table>
<h2>Configuration Options</h2>
<p>The chat system supports several configuration options:</p>
<ul>
<li><strong>SOCKET_URL</strong>: WebSocket server URL</li>
<li><strong>MESSAGE_PAGE_SIZE</strong>: Number of messages to load per page (default: 50)</li>
<li><strong>TYPING_INDICATOR_TIMEOUT</strong>: Time in ms before typing indicator disappears (default: 5000)</li>
<li><strong>MESSAGE_RETENTION_DAYS</strong>: Number of days to retain messages (default: 365)</li>
<li><strong>E2E_ENCRYPTION_ENABLED</strong>: Whether E2E encryption is enabled (default: true)</li>
<li><strong>KEY_ROTATION_INTERVAL</strong>: Interval for encryption key rotation (default: 7d)</li>
<li><strong>OFFLINE_STORAGE_LIMIT</strong>: Maximum number of messages to store offline (default: 1000)</li>
</ul>
<h2>Known Limitations</h2>
<ol>
<li><p><strong>Offline Support</strong>:</p>
<ul>
<li>Limited offline message composition</li>
<li>Sync conflicts may occur with extended offline use</li>
<li>Attachments require online connection</li>
</ul>
</li>
<li><p><strong>Group Chats</strong>:</p>
<ul>
<li>Currently limited to one-on-one conversations</li>
<li>Group chat functionality is planned for future release</li>
</ul>
</li>
<li><p><strong>Media Sharing</strong>:</p>
<ul>
<li>File size limitations (10MB per file)</li>
<li>Limited preview capabilities for certain file types</li>
<li>No built-in media editing tools</li>
</ul>
</li>
</ol>
<h2>Future Enhancements</h2>
<ol>
<li><p><strong>Advanced Messaging</strong>:</p>
<ul>
<li>Implement group chat functionality</li>
<li>Add message reactions and replies</li>
<li>Implement message search capabilities</li>
<li>Add voice and video messaging</li>
</ul>
</li>
<li><p><strong>Media Enhancements</strong>:</p>
<ul>
<li>Improve media sharing with compression</li>
<li>Add in-chat photo/video viewer</li>
<li>Implement ephemeral media messages</li>
<li>Add file preview capabilities</li>
</ul>
</li>
<li><p><strong>User Experience</strong>:</p>
<ul>
<li>Implement message translation</li>
<li>Add chat themes and customization</li>
<li>Improve notification management</li>
<li>Add chat archiving functionality</li>
</ul>
</li>
<li><p><strong>Performance</strong>:</p>
<ul>
<li>Implement progressive loading for large conversations</li>
<li>Optimize WebSocket connection management</li>
<li>Improve offline capabilities</li>
<li>Enhance encryption performance</li>
</ul>
</li>
</ol>

      </section>
    

      <section id="related">
        <h2>Related Components</h2>
        <h2>Related Documentation</h2>
<ul>
<li><a href="/docs/END_TO_END_ENCRYPTION.MD">END_TO_END_ENCRYPTION.MD</a></li>
<li><a href="/docs/SOCKET_ARCHITECTURE.MD">SOCKET_ARCHITECTURE.MD</a></li>
<li><a href="/docs/NOTIFICATION_SYSTEM.MD">NOTIFICATION_SYSTEM.MD</a></li>
<li><a href="/docs/API_DOCUMENTATION.MD">API_DOCUMENTATION.MD</a></li>
</ul>

      </section>
    
              </article>
            </div>
          </main>
        </body>
      </html>
    