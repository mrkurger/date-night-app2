<div class="chat-container">
  <!-- Left Sidebar with Conversation List -->
  <div class="chat-sidebar">
    <div class="chat-header">
      <h2>Messages</h2>
      <div class="chat-header-actions">
        <button nbButton ghost nbTooltip="New Message" (click)="openNewMessageDialog()">
          <nb-icon icon="plus-outline"></nb-icon>
        </button>
        <button nbButton ghost nbTooltip="Settings" [nbContextMenu]="settingsItems">
          <nb-icon icon="more-vertical-outline"></nb-icon>
        </button>
      </div>
    </div>

    <div class="chat-search">
      <nb-form-field>
        <nb-icon nbPrefix icon="search-outline"></nb-icon>
        <input
          nbInput
          fullWidth
          type="text"
          placeholder="Search conversations..."
          [(ngModel)]="searchQuery"
          (ngModelChange)="filterConversations()"
        />
        <button
          nbSuffix
          nbButton
          ghost
          *ngIf="searchQuery"
          (click)="clearSearch()"
          nbTooltip="Clear search"
        >
          <nb-icon icon="close-outline"></nb-icon>
        </button>
      </nb-form-field>
    </div>

    <div class="conversation-list" #conversationList>
      <div
        *ngFor="let contact of filteredContacts"
        class="conversation-item"
        [class.active]="contact.id === selectedContactId"
        (click)="selectContact(contact.id)"
      >
        <app-avatar
          [imageUrl]="contact.profileImage"
          [name]="contact.name"
          [status]="contact.status"
          size="medium"
        ></app-avatar>
        <div class="conversation-info">
          <div class="conversation-header">
            <span class="contact-name">{{ contact.name }}</span>
            <span class="last-message-time">{{
              contact.lastMessage?.timestamp | date: 'shortTime'
            }}</span>
          </div>
          <div class="conversation-preview">
            <p class="last-message">
              {{ contact.lastMessage?.content || 'No messages yet' }}
            </p>
            <nb-badge
              *ngIf="contact.unreadCount"
              [text]="contact.unreadCount.toString()"
              status="primary"
              position="top right"
            ></nb-badge>
          </div>
        </div>
      </div>

      <div *ngIf="loading" class="loading-conversations">
        <app-skeleton-loader *ngFor="let i of [1, 2, 3, 4, 5]"></app-skeleton-loader>
      </div>

      <div *ngIf="!loading && filteredContacts.length === 0" class="no-conversations">
        <nb-icon icon="message-circle-outline" size="large"></nb-icon>
        <p>No conversations found</p>
      </div>
    </div>
  </div>

  <!-- Main Chat Area -->
  <div class="chat-main">
    <ng-container *ngIf="selectedContactId; else noChat">
      <div class="chat-header">
        <div class="contact-info">
          <app-avatar
            [imageUrl]="selectedContact?.profileImage"
            [name]="selectedContact?.name"
            [status]="selectedContact?.status"
            size="small"
          ></app-avatar>
          <div class="contact-details">
            <h3>{{ selectedContact?.name }}</h3>
            <span class="status-text">{{ selectedContact?.status | titlecase }}</span>
          </div>
        </div>
        <div class="chat-actions">
          <button nbButton ghost nbTooltip="Voice Call">
            <nb-icon icon="phone-outline"></nb-icon>
          </button>
          <button nbButton ghost nbTooltip="Video Call">
            <nb-icon icon="video-outline"></nb-icon>
          </button>
          <button nbButton ghost nbTooltip="Chat Info" [nbContextMenu]="chatMenuItems">
            <nb-icon icon="more-vertical-outline"></nb-icon>
          </button>
        </div>
      </div>

      <div class="messages-container" #messagesContainer>
        <div class="messages-list">
          <div *ngFor="let message of currentMessages" class="message-group">
            <div class="message-date" *ngIf="showMessageDate(message)">
              {{ message.timestamp | date }}
            </div>
            <div
              class="message"
              [class.outgoing]="message.senderId === currentUserId"
              [class.incoming]="message.senderId !== currentUserId"
            >
              <div class="message-content">
                <p>{{ message.content }}</p>
                <span class="message-time">{{ message.timestamp | date: 'shortTime' }}</span>
              </div>
            </div>
          </div>

          <div *ngIf="isTyping" class="typing-indicator">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
          </div>
        </div>
      </div>

      <div class="message-input">
        <nb-form-field>
          <nb-icon nbPrefix icon="message-square-outline"></nb-icon>
          <input
            nbInput
            fullWidth
            type="text"
            placeholder="Type a message..."
            [(ngModel)]="newMessage"
            (keyup.enter)="sendMessage()"
            (input)="onTyping()"
          />
          <div nbSuffix class="message-actions">
            <button nbButton ghost nbTooltip="Add attachment">
              <nb-icon icon="attach-outline"></nb-icon>
            </button>
            <button nbButton ghost nbTooltip="Add emoji">
              <nb-icon icon="smiling-face-outline"></nb-icon>
            </button>
            <button
              nbButton
              status="primary"
              size="small"
              [disabled]="!newMessage.trim()"
              (click)="sendMessage()"
            >
              <nb-icon icon="paper-plane-outline"></nb-icon>
            </button>
          </div>
        </nb-form-field>
      </div>
    </ng-container>

    <ng-template #noChat>
      <div class="no-chat-selected">
        <nb-icon icon="message-square-outline" size="huge"></nb-icon>
        <h3>Select a conversation</h3>
        <p>Choose a contact to start chatting</p>
      </div>
    </ng-template>
  </div>
</div>

<!-- New Message Dialog Template -->
<ng-template #newMessageDialog>
  <h2 nb-dialog-title>New Message</h2>
  <nb-dialog-content>
    <nb-form-field appearance="outline" class="full-width">
      <nb-form-field-label>Search contacts</nb-form-field-label>
      <input nbInput fullWidth [(ngModel)]="newMessageSearch" placeholder="Type a name..." />
      <nb-icon matPrefix>search"></nb-icon>
    </nb-form-field>

    <div class="contact-list">
      <div
        *ngFor="let contact of filteredNewMessageContacts"
        class="contact-option"
        (click)="selectNewMessageContact(contact)"
      >
        <nb-user
          [imageUrl]="contact.imageUrl"
          [name]="contact.name"
          [isOnline]="contact.online"
          size="small"
        >
        </nb-user>
        <div class="contact-name">{{ contact.name }}</div>
      </div>

      <div *ngIf="filteredNewMessageContacts.length === 0" class="no-contacts">
        <p>No contacts found</p>
      </div>
    </div>
  </nb-dialog-content>
  <nb-dialog-actions align="end">
    <button nbButton nb-dialog-close>Cancel</button>
  </nb-dialog-actions>
</ng-template>

<!-- Image Preview Dialog Template -->
<ng-template #imagePreviewDialog>
  <div class="image-preview-container">
    <button nbButton ghost class="close-button" nb-dialog-close>
      <nb-icon icon="close"></nb-icon>
    </button>

    <img [src]="previewImage?.url" [alt]="previewImage?.name" class="preview-image" />

    <div class="image-preview-actions">
      <button nbButton ghost nbTooltip="Download" (click)="downloadImage()">
        <nb-icon icon="download"></nb-icon>
      </button>
      <button nbButton ghost nbTooltip="Share" (click)="shareImage()">
        <nb-icon icon="share"></nb-icon>
      </button>
    </div>
  </div>
</ng-template>

<!-- Search in Chat Dialog Template -->
<ng-template #searchInChatDialog>
  <h2 nb-dialog-title>Search in Conversation</h2>
  <nb-dialog-content>
    <nb-form-field appearance="outline" class="full-width">
      <nb-form-field-label>Search messages</nb-form-field-label>
      <input nbInput fullWidth [(ngModel)]="chatSearchQuery" placeholder="Type to search..." />
      <nb-icon matPrefix>search"></nb-icon>
    </nb-form-field>

    <div class="search-results">
      <div
        *ngFor="let result of chatSearchResults"
        class="search-result-item"
        (click)="scrollToMessage(result)"
      >
        <div class="result-sender">{{ result.sender.username }}</div>
        <div class="result-message" [innerHTML]="highlightSearchText(result.message)"></div>
        <div class="result-time">{{ result.timestamp | date: 'short' }}</div>
      </div>

      <div *ngIf="chatSearchResults.length === 0 && chatSearchQuery" class="no-results">
        <p>No messages found</p>
      </div>
    </div>
  </nb-dialog-content>
  <nb-dialog-actions align="end">
    <button nbButton nb-dialog-close>Close</button>
  </nb-dialog-actions>
</ng-template>

<!-- Media Gallery Dialog Template -->
<ng-template #mediaGalleryDialog>
  <h2 nb-dialog-title>Media Gallery</h2>
  <nb-dialog-content>
    <div class="gallery-tabs">
      <button nbButton [class.active]="galleryTab === 'images'" (click)="galleryTab = 'images'">
        Images
      </button>
      <button nbButton [class.active]="galleryTab === 'files'" (click)="galleryTab = 'files'">
        Files
      </button>
      <button nbButton [class.active]="galleryTab === 'links'" (click)="galleryTab = 'links'">
        Links
      </button>
    </div>

    <!-- Images Tab -->
    <div *ngIf="galleryTab === 'images'" class="gallery-images">
      <div
        *ngFor="let image of galleryImages"
        class="gallery-image"
        (click)="openImagePreview(image)"
      >
        <img [src]="image.url" [alt]="image.name" />
      </div>

      <div *ngIf="galleryImages.length === 0" class="no-media">
        <p>No images shared in this conversation</p>
      </div>
    </div>

    <!-- Files Tab -->
    <div *ngIf="galleryTab === 'files'" class="gallery-files">
      <div
        *ngFor="let file of galleryFiles"
        class="gallery-file"
        (click)="downloadAttachment(file)"
      >
        <nb-icon icon="{{ getFileIcon(file) }}"></nb-icon>
        <div class="file-info">
          <div class="file-name">{{ file.name }}</div>
          <div class="file-meta">
            <span class="file-size">{{ formatFileSize(file.size) }}</span>
            <span class="file-date">{{ file.timestamp | date: 'shortDate' }}</span>
          </div>
        </div>
        <button nbButton ghost>
          <nb-icon icon="download"></nb-icon>
        </button>
      </div>

      <div *ngIf="galleryFiles.length === 0" class="no-media">
        <p>No files shared in this conversation</p>
      </div>
    </div>

    <!-- Links Tab -->
    <div *ngIf="galleryTab === 'links'" class="gallery-links">
      <div *ngFor="let link of galleryLinks" class="gallery-link" (click)="openLink(link.url)">
        <nb-icon icon="link"></nb-icon>
        <div class="link-info">
          <div class="link-title">{{ link.title || link.url }}</div>
          <div class="link-url">{{ link.url }}</div>
        </div>
        <div class="link-date">{{ link.timestamp | date: 'shortDate' }}</div>
      </div>

      <div *ngIf="galleryLinks.length === 0" class="no-media">
        <p>No links shared in this conversation</p>
      </div>
    </div>
  </nb-dialog-content>
  <nb-dialog-actions align="end">
    <button nbButton nb-dialog-close>Close</button>
  </nb-dialog-actions>
</ng-template>
