<div class="chat-container">
  <!-- Left Sidebar with Conversation List -->
  <div class="chat-sidebar">
    <div class="chat-header">
      <h2>Messages</h2>
      <div class="chat-header-actions">
        <button mat-icon-button matTooltip="New Message" (click)="openNewMessageDialog()">
          <mat-icon>add</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Settings" [matMenuTriggerFor]="settingsMenu">
          <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #settingsMenu="matMenu">
          <button mat-menu-item (click)="toggleNotifications()">
            <mat-icon>{{ notificationsEnabled ? 'notifications' : 'notifications_off' }}</mat-icon>
            <span>{{ notificationsEnabled ? 'Mute Notifications' : 'Enable Notifications' }}</span>
          </button>
          <button mat-menu-item (click)="markAllAsRead()">
            <mat-icon>done_all</mat-icon>
            <span>Mark All as Read</span>
          </button>
          <button mat-menu-item (click)="archiveAllChats()">
            <mat-icon>archive</mat-icon>
            <span>Archive All</span>
          </button>
        </mat-menu>
      </div>
    </div>

    <div class="chat-search">
      <mat-form-field appearance="outline" class="search-field">
        <mat-icon matPrefix>search</mat-icon>
        <input matInput placeholder="Search conversations..." [(ngModel)]="searchTerm" />
        <button
          *ngIf="searchTerm"
          matSuffix
          mat-icon-button
          aria-label="Clear"
          (click)="searchTerm = ''"
        >
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>

      <!-- Conversation Filters -->
      <div class="conversation-filters">
        <button
          mat-button
          [class.active]="currentFilter === 'all'"
          (click)="filterConversations('all')"
        >
          All
        </button>
        <button
          mat-button
          [class.active]="currentFilter === 'unread'"
          (click)="filterConversations('unread')"
        >
          Unread
        </button>
        <button
          mat-button
          [class.active]="currentFilter === 'archived'"
          (click)="filterConversations('archived')"
        >
          Archived
        </button>
      </div>
    </div>

    <div class="chat-contacts">
      <!-- Loading State -->
      <div *ngIf="loadingContacts" class="contacts-loading">
        <emerald-skeleton-loader
          type="list"
          [count]="3"
          [animated]="true"
        ></emerald-skeleton-loader>
      </div>

      <!-- Contact List -->
      <div
        *ngFor="let contact of filteredContacts"
        class="contact-item"
        [class.active]="selectedContactId === contact.id"
        [class.unread]="contact.unreadCount > 0"
        (click)="selectContact(contact.id)"
      >
        <emerald-avatar
          [imageUrl]="contact.imageUrl"
          [name]="contact.name"
          [isOnline]="contact.online"
          size="medium"
        >
        </emerald-avatar>

        <div class="contact-info">
          <div class="contact-name-row">
            <div class="contact-name">{{ contact.name }}</div>
            <div class="contact-time">{{ contact.lastMessageTime | date: 'shortTime' }}</div>
          </div>
          <div class="contact-preview-row">
            <div class="contact-preview">
              <span *ngIf="contact.typing" class="typing-indicator">typing...</span>
              <span *ngIf="!contact.typing">{{ contact.lastMessage }}</span>
            </div>
            <div class="contact-badges">
              <div class="unread-badge" *ngIf="contact.unreadCount">{{ contact.unreadCount }}</div>
              <mat-icon *ngIf="contact.pinned" class="pin-icon">push_pin</mat-icon>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="filteredContacts.length === 0 && !loadingContacts" class="empty-contacts">
        <mat-icon>forum</mat-icon>
        <p>No conversations found</p>
        <button mat-stroked-button color="primary" (click)="openNewMessageDialog()">
          <mat-icon>add</mat-icon>
          Start a new chat
        </button>
      </div>
    </div>
  </div>

  <!-- Main Chat Area -->
  <div class="chat-main">
    <!-- Active Conversation -->
    <div *ngIf="selectedContactId" class="chat-conversation">
      <!-- Conversation Header -->
      <div class="chat-main-header">
        <div class="header-left">
          <button
            mat-icon-button
            class="back-button"
            (click)="deselectContact()"
            matTooltip="Back to conversations"
          >
            <mat-icon>arrow_back</mat-icon>
          </button>

          <emerald-avatar
            [imageUrl]="getSelectedContact()?.imageUrl"
            [name]="getSelectedContact()?.name"
            [isOnline]="getSelectedContact()?.online"
            size="medium"
            (avatarClick)="viewContactProfile()"
          >
          </emerald-avatar>

          <div class="chat-recipient">
            <div class="recipient-name">{{ getSelectedContact()?.name }}</div>
            <div class="recipient-status" [class.online]="getSelectedContact()?.online">
              {{
                getSelectedContact()?.online
                  ? 'Online'
                  : 'Last seen ' + (getSelectedContact()?.lastSeen | date: 'shortTime')
              }}
            </div>
          </div>
        </div>

        <div class="header-actions">
          <button mat-icon-button matTooltip="Media Gallery" (click)="openMediaGallery()">
            <mat-icon>photo_library</mat-icon>
          </button>
          <button mat-icon-button matTooltip="Search in Conversation" (click)="openSearchInChat()">
            <mat-icon>search</mat-icon>
          </button>
          <button mat-icon-button [matMenuTriggerFor]="chatMenu" matTooltip="More Options">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #chatMenu="matMenu">
            <button mat-menu-item (click)="togglePin()">
              <mat-icon>{{ isPinned() ? 'push_pin' : 'push_pin' }}</mat-icon>
              <span>{{ isPinned() ? 'Unpin Conversation' : 'Pin Conversation' }}</span>
            </button>
            <button mat-menu-item [matMenuTriggerFor]="autoDeletionMenu">
              <mat-icon>auto_delete</mat-icon>
              <span>Message Auto-Deletion</span>
            </button>
            <button mat-menu-item (click)="blockContact()">
              <mat-icon>block</mat-icon>
              <span>Block Contact</span>
            </button>
            <button mat-menu-item (click)="clearConversation()">
              <mat-icon>delete_sweep</mat-icon>
              <span>Clear Conversation</span>
            </button>
          </mat-menu>

          <!-- Auto-Deletion Submenu -->
          <mat-menu #autoDeletionMenu="matMenu">
            <button mat-menu-item (click)="configureMessageAutoDeletion(true, 1)">
              <mat-icon>timer</mat-icon>
              <span>Delete after 1 day</span>
            </button>
            <button mat-menu-item (click)="configureMessageAutoDeletion(true, 7)">
              <mat-icon>timer</mat-icon>
              <span>Delete after 7 days</span>
            </button>
            <button mat-menu-item (click)="configureMessageAutoDeletion(true, 30)">
              <mat-icon>timer</mat-icon>
              <span>Delete after 30 days</span>
            </button>
            <button mat-menu-item (click)="configureMessageAutoDeletion(false, 0)">
              <mat-icon>timer_off</mat-icon>
              <span>Disable auto-deletion</span>
            </button>
          </mat-menu>
        </div>
      </div>

      <!-- Message List -->
      <div class="message-list" #messageList>
        <div class="message-group" *ngFor="let group of messageGroups">
          <div class="date-separator">{{ group.date | date }}</div>

          <div
            class="message"
            *ngFor="let message of group.messages"
            [id]="'message-' + message._id"
            [ngClass]="{
              'message--outgoing': message.sender.id === currentUserId,
              'message--incoming': message.sender.id !== currentUserId,
              'message--expiring': message.expiresAt,
              'message--about-to-expire': isAboutToExpire(message.expiresAt),
            }"
          >
            <!-- Message Content -->
            <div class="message__content">
              <div
                class="message-bubble"
                [class.temporary-message]="message.expiresAt"
                [class.about-to-expire]="message.expiresAt && isAboutToExpire(message.expiresAt)"
              >
                <!-- Temporary Message Indicator -->
                <div
                  *ngIf="message.expiresAt"
                  class="temporary-message-indicator"
                  [matTooltip]="getRemainingTime(message.expiresAt)"
                >
                  <mat-icon>timer</mat-icon>
                </div>

                <!-- Message Text -->
                <div
                  class="message-content"
                  [innerHTML]="formatMessageContent(message.message)"
                ></div>

                <!-- Message Attachments -->
                <div
                  *ngIf="message.attachments && message.attachments.length > 0"
                  class="message-attachments"
                >
                  <!-- Image Attachment -->
                  <div *ngFor="let attachment of message.attachments" class="attachment">
                    <img
                      *ngIf="isImageAttachment(attachment)"
                      [src]="attachment.url"
                      [alt]="attachment.name"
                      (click)="openImagePreview(attachment)"
                    />

                    <!-- File Attachment -->
                    <div
                      *ngIf="!isImageAttachment(attachment)"
                      class="file-attachment"
                      (click)="downloadAttachment(attachment)"
                    >
                      <mat-icon>{{ getFileIcon(attachment) }}</mat-icon>
                      <div class="file-info">
                        <div class="file-name">{{ attachment.name }}</div>
                        <div class="file-size">{{ formatFileSize(attachment.size) }}</div>
                      </div>
                      <button mat-icon-button>
                        <mat-icon>download</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Message Metadata -->
                <div class="message-meta">
                  <span class="message-time">{{ message.timestamp | date: 'shortTime' }}</span>
                  <!-- Expiry indicator for temporary messages -->
                  <span
                    *ngIf="message.expiresAt"
                    class="message-expiry"
                    [matTooltip]="getRemainingTime(message.expiresAt)"
                  >
                    <mat-icon class="expiry-icon">timer</mat-icon>
                  </span>
                  <span
                    *ngIf="message.sender.id === currentUserId"
                    class="message-status"
                    [class.read]="message.read"
                  >
                    <mat-icon class="status-icon">{{
                      message.read ? 'done_all' : 'done'
                    }}</mat-icon>
                  </span>
                </div>
              </div>

              <!-- Expiry Indicator -->
              <span
                *ngIf="message.expiresAt"
                class="message__expiry"
                [matTooltip]="getRemainingTime(message.expiresAt)"
              >
                <mat-icon [class.rotating]="isAboutToExpire(message.expiresAt)">timer</mat-icon>
              </span>
            </div>
          </div>
        </div>

        <!-- Typing Indicator -->
        <div *ngIf="isContactTyping" class="typing-indicator-container">
          <emerald-avatar
            [imageUrl]="getSelectedContact()?.imageUrl"
            [name]="getSelectedContact()?.name"
            size="small"
          >
          </emerald-avatar>
          <div class="typing-bubble">
            <div class="typing-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="messages.length === 0" class="empty-messages">
          <mat-icon>chat</mat-icon>
          <h3>No messages yet</h3>
          <p>Start the conversation by sending a message below!</p>
        </div>
      </div>

      <!-- Reply Preview (if replying to a message) -->
      <div *ngIf="replyingTo" class="reply-preview">
        <div class="reply-content">
          <mat-icon>reply</mat-icon>
          <div class="reply-text">
            <div class="reply-to">Replying to {{ replyingTo.sender.username }}</div>
            <div class="reply-message">{{ truncateMessage(replyingTo.message) }}</div>
          </div>
        </div>
        <button mat-icon-button (click)="cancelReply()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <!-- Message Input Area -->
      <div class="message-input-area">
        <!-- Reply Preview -->
        <div class="reply-preview" *ngIf="replyingTo">
          <div class="reply-content">
            <mat-icon>reply</mat-icon>
            <div class="reply-text">
              <div class="reply-to">Replying to {{ replyingTo.sender.username }}</div>
              <div class="reply-message">{{ truncateMessage(replyingTo.message) }}</div>
            </div>
          </div>
          <button mat-icon-button (click)="cancelReply()">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <!-- Temporary Message Mode Indicator -->
        <div class="temp-message-indicator" *ngIf="temporaryMessageMode">
          <mat-icon>timer</mat-icon>
          <span>Temporary message mode: {{ formatTTL(temporaryMessageTTL) }}</span>
          <button mat-icon-button (click)="toggleTemporaryMessageMode()">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <!-- Input Controls -->
        <div class="input-controls">
          <!-- Attachment Button -->
          <button mat-icon-button (click)="openAttachmentMenu()" matTooltip="Add attachment">
            <mat-icon>attach_file</mat-icon>
          </button>

          <!-- Temporary Message Toggle -->
          <button
            mat-icon-button
            (click)="toggleTemporaryMessageMode()"
            [class.active]="temporaryMessageMode"
            [matTooltip]="
              temporaryMessageMode ? 'Disable temporary message' : 'Enable temporary message'
            "
          >
            <mat-icon>timer</mat-icon>
          </button>

          <!-- Text Input -->
          <div class="message-input" [class.temp-message-mode]="temporaryMessageMode">
            <textarea
              [(ngModel)]="newMessage"
              (keyup.enter)="handleEnterKey($event)"
              (input)="onTyping()"
              [placeholder]="
                temporaryMessageMode ? 'Type a temporary message...' : 'Type a message...'
              "
              #messageInput
            >
            </textarea>
          </div>

          <!-- Emoji Picker -->
          <button mat-icon-button (click)="toggleEmojiPicker()" matTooltip="Add emoji">
            <mat-icon>sentiment_satisfied_alt</mat-icon>
          </button>

          <!-- Send Button -->
          <button
            mat-icon-button
            (click)="sendMessage()"
            [disabled]="!canSendMessage()"
            matTooltip="Send message"
          >
            <mat-icon>send</mat-icon>
          </button>
        </div>

        <!-- Emoji Picker Panel -->
        <div class="emoji-picker" *ngIf="showEmojiPicker">
          <div class="emoji-categories">
            <button
              mat-icon-button
              *ngFor="let category of emojiCategories"
              (click)="selectEmojiCategory(category)"
            >
              <mat-icon>{{ category.icon }}</mat-icon>
            </button>
          </div>
          <div class="emoji-list">
            <button
              *ngFor="let emoji of currentCategoryEmojis"
              class="emoji-item"
              (click)="addEmoji(emoji)"
            >
              {{ emoji }}
            </button>
          </div>
        </div>
      </div>

      <!-- Message Settings Menu -->
      <mat-menu #messageSettings="matMenu">
        <button
          mat-menu-item
          (click)="configureMessageAutoDeletion(!messageAutoDeletionEnabled, 7)"
        >
          <mat-icon>{{ messageAutoDeletionEnabled ? 'timer_off' : 'timer' }}</mat-icon>
          <span>{{
            messageAutoDeletionEnabled ? 'Disable auto-deletion' : 'Enable auto-deletion'
          }}</span>
        </button>

        <mat-divider></mat-divider>

        <!-- Temporary Message Duration Options -->
        <button mat-menu-item [matMenuTriggerFor]="tempMessageDuration">
          <mat-icon>schedule</mat-icon>
          <span>Temporary message duration</span>
        </button>
      </mat-menu>

      <!-- Temporary Message Duration Submenu -->
      <mat-menu #tempMessageDuration="matMenu">
        <button mat-menu-item (click)="setTemporaryMessageTTL(1)">1 hour</button>
        <button mat-menu-item (click)="setTemporaryMessageTTL(4)">4 hours</button>
        <button mat-menu-item (click)="setTemporaryMessageTTL(8)">8 hours</button>
        <button mat-menu-item (click)="setTemporaryMessageTTL(24)">1 day</button>
        <button mat-menu-item (click)="setTemporaryMessageTTL(48)">2 days</button>
        <button mat-menu-item (click)="setTemporaryMessageTTL(72)">3 days</button>
        <button mat-menu-item (click)="setTemporaryMessageTTL(168)">7 days</button>
      </mat-menu>
    </div>

    <!-- Empty State (No Conversation Selected) -->
    <div *ngIf="!selectedContactId" class="empty-state">
      <div class="empty-state-content">
        <mat-icon class="empty-icon">chat</mat-icon>
        <h3>Select a conversation</h3>
        <p>Choose a contact from the list to start chatting</p>
        <button mat-raised-button color="primary" (click)="openNewMessageDialog()">
          <mat-icon>add</mat-icon>
          Start a new chat
        </button>
      </div>
    </div>
  </div>
</div>

<!-- New Message Dialog Template -->
<ng-template #newMessageDialog>
  <h2 mat-dialog-title>New Message</h2>
  <mat-dialog-content>
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Search contacts</mat-label>
      <input matInput [(ngModel)]="newMessageSearch" placeholder="Type a name..." />
      <mat-icon matPrefix>search</mat-icon>
    </mat-form-field>

    <div class="contact-list">
      <div
        *ngFor="let contact of filteredNewMessageContacts"
        class="contact-option"
        (click)="selectNewMessageContact(contact)"
      >
        <emerald-avatar
          [imageUrl]="contact.imageUrl"
          [name]="contact.name"
          [isOnline]="contact.online"
          size="small"
        >
        </emerald-avatar>
        <div class="contact-name">{{ contact.name }}</div>
      </div>

      <div *ngIf="filteredNewMessageContacts.length === 0" class="no-contacts">
        <p>No contacts found</p>
      </div>
    </div>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Cancel</button>
  </mat-dialog-actions>
</ng-template>

<!-- Image Preview Dialog Template -->
<ng-template #imagePreviewDialog>
  <div class="image-preview-container">
    <button mat-icon-button class="close-button" mat-dialog-close>
      <mat-icon>close</mat-icon>
    </button>

    <img [src]="previewImage?.url" [alt]="previewImage?.name" class="preview-image" />

    <div class="image-preview-actions">
      <button mat-icon-button matTooltip="Download" (click)="downloadImage()">
        <mat-icon>download</mat-icon>
      </button>
      <button mat-icon-button matTooltip="Share" (click)="shareImage()">
        <mat-icon>share</mat-icon>
      </button>
    </div>
  </div>
</ng-template>

<!-- Search in Chat Dialog Template -->
<ng-template #searchInChatDialog>
  <h2 mat-dialog-title>Search in Conversation</h2>
  <mat-dialog-content>
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Search messages</mat-label>
      <input matInput [(ngModel)]="chatSearchQuery" placeholder="Type to search..." />
      <mat-icon matPrefix>search</mat-icon>
    </mat-form-field>

    <div class="search-results">
      <div
        *ngFor="let result of chatSearchResults"
        class="search-result-item"
        (click)="scrollToMessage(result)"
      >
        <div class="result-sender">{{ result.sender.username }}</div>
        <div class="result-message" [innerHTML]="highlightSearchText(result.message)"></div>
        <div class="result-time">{{ result.timestamp | date: 'short' }}</div>
      </div>

      <div *ngIf="chatSearchResults.length === 0 && chatSearchQuery" class="no-results">
        <p>No messages found</p>
      </div>
    </div>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Close</button>
  </mat-dialog-actions>
</ng-template>

<!-- Media Gallery Dialog Template -->
<ng-template #mediaGalleryDialog>
  <h2 mat-dialog-title>Media Gallery</h2>
  <mat-dialog-content>
    <div class="gallery-tabs">
      <button mat-button [class.active]="galleryTab === 'images'" (click)="galleryTab = 'images'">
        Images
      </button>
      <button mat-button [class.active]="galleryTab === 'files'" (click)="galleryTab = 'files'">
        Files
      </button>
      <button mat-button [class.active]="galleryTab === 'links'" (click)="galleryTab = 'links'">
        Links
      </button>
    </div>

    <!-- Images Tab -->
    <div *ngIf="galleryTab === 'images'" class="gallery-images">
      <div
        *ngFor="let image of galleryImages"
        class="gallery-image"
        (click)="openImagePreview(image)"
      >
        <img [src]="image.url" [alt]="image.name" />
      </div>

      <div *ngIf="galleryImages.length === 0" class="no-media">
        <p>No images shared in this conversation</p>
      </div>
    </div>

    <!-- Files Tab -->
    <div *ngIf="galleryTab === 'files'" class="gallery-files">
      <div
        *ngFor="let file of galleryFiles"
        class="gallery-file"
        (click)="downloadAttachment(file)"
      >
        <mat-icon>{{ getFileIcon(file) }}</mat-icon>
        <div class="file-info">
          <div class="file-name">{{ file.name }}</div>
          <div class="file-meta">
            <span class="file-size">{{ formatFileSize(file.size) }}</span>
            <span class="file-date">{{ file.timestamp | date: 'shortDate' }}</span>
          </div>
        </div>
        <button mat-icon-button>
          <mat-icon>download</mat-icon>
        </button>
      </div>

      <div *ngIf="galleryFiles.length === 0" class="no-media">
        <p>No files shared in this conversation</p>
      </div>
    </div>

    <!-- Links Tab -->
    <div *ngIf="galleryTab === 'links'" class="gallery-links">
      <div *ngFor="let link of galleryLinks" class="gallery-link" (click)="openLink(link.url)">
        <mat-icon>link</mat-icon>
        <div class="link-info">
          <div class="link-title">{{ link.title || link.url }}</div>
          <div class="link-url">{{ link.url }}</div>
        </div>
        <div class="link-date">{{ link.timestamp | date: 'shortDate' }}</div>
      </div>

      <div *ngIf="galleryLinks.length === 0" class="no-media">
        <p>No links shared in this conversation</p>
      </div>
    </div>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Close</button>
  </mat-dialog-actions>
</ng-template>
