<div class="chat-room">
  <!-- Chat Header -->
  <div class="chat-room__header">
    <div class="chat-room__back" (click)="navigateBack()">
      <i class="icon-arrow-back"></i>
    </div>

    <div class="chat-room__info" *ngIf="room">
      <div class="chat-room__avatar" *ngIf="otherUser">
        <img [src]="otherUser.avatar" [alt]="otherUser.name" />
        <span class="chat-room__status" [class.online]="true"></span>
      </div>

      <div class="chat-room__details">
        <div class="chat-room__name">
          {{ room.name || (otherUser ? otherUser.name : 'Chat Room') }}
        </div>
        <div class="chat-room__subtitle">
          <span *ngIf="encryptionStatus === 'enabled'" class="chat-room__encryption">
            <i class="icon-lock"></i> End-to-end encrypted
          </span>
          <span
            *ngIf="encryptionStatus === 'disabled'"
            class="chat-room__encryption chat-room__encryption--disabled"
          >
            <i class="icon-lock-open"></i> Encryption disabled
          </span>
          <span
            *ngIf="encryptionStatus === 'initializing'"
            class="chat-room__encryption chat-room__encryption--initializing"
          >
            <i class="icon-sync"></i> Setting up encryption...
          </span>
        </div>
      </div>
    </div>

    <div class="chat-room__actions">
      <button class="chat-room__action-btn" (click)="toggleSettings()" title="Chat Settings">
        <i class="icon-settings"></i>
      </button>
    </div>
  </div>

  <!-- Chat Settings Panel -->
  <div class="chat-room__settings-panel" *ngIf="showSettings">
    <app-chat-settings
      [roomId]="roomId"
      [settings]="{
        messageExpiryEnabled: room?.messageExpiryEnabled || false,
        messageExpiryTime: room?.messageExpiryTime || 24,
        encryptionEnabled: isEncryptionEnabled,
      }"
      (settingsChanged)="onSettingsChanged($event)"
    ></app-chat-settings>
  </div>

  <!-- Chat Messages -->
  <div class="chat-room__messages" #messageContainer (scroll)="onScroll($event)">
    <!-- Loading Indicator -->
    <div class="chat-room__loading" *ngIf="loading">
      <div class="spinner"></div>
      <div>Loading messages...</div>
    </div>

    <!-- Load More Button -->
    <div class="chat-room__load-more" *ngIf="hasMoreMessages && !loading && !loadingMore">
      <button (click)="loadMoreMessages()">Load earlier messages</button>
    </div>

    <!-- Loading More Indicator -->
    <div class="chat-room__loading-more" *ngIf="loadingMore">
      <div class="spinner spinner--small"></div>
      <div>Loading more messages...</div>
    </div>

    <!-- No Messages -->
    <div class="chat-room__empty" *ngIf="!loading && messages.length === 0">
      <div class="chat-room__empty-icon">
        <i class="icon-chat"></i>
      </div>
      <div class="chat-room__empty-text">No messages yet. Start the conversation!</div>
    </div>

    <!-- Message List -->
    <div class="chat-room__message-list" *ngIf="!loading && messages.length > 0">
      <app-chat-message
        *ngFor="let message of messages"
        [message]="message"
        [roomId]="roomId"
        [showSender]="true"
      ></app-chat-message>
    </div>
  </div>

  <!-- Chat Input -->
  <div class="chat-room__input">
    <div class="chat-room__attachment">
      <label for="file-upload" class="chat-room__attachment-btn">
        <i class="icon-attachment"></i>
      </label>
      <input
        type="file"
        id="file-upload"
        multiple
        (change)="onFileSelected($event)"
        accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt"
      />
    </div>

    <div class="chat-room__message-input">
      <textarea
        #messageInput
        [(ngModel)]="newMessage"
        placeholder="Type a message..."
        (keydown.enter)="$event.preventDefault(); sendMessage()"
        (input)="onTyping()"
      ></textarea>
    </div>

    <div class="chat-room__send">
      <button class="chat-room__send-btn" [disabled]="!newMessage.trim()" (click)="sendMessage()">
        <i class="icon-send"></i>
      </button>
    </div>
  </div>
</div>
