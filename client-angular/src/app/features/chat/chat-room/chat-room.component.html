<div class="chat-room">
  <nb-card>
    <nb-card-header>
      <div class="chat-header" *ngIf="contact">
        <nb-user [name]="contact.username" [picture]="contact.avatar" size="medium"> </nb-user>
        <nb-actions size="small">
          <nb-action
            icon="more-vertical-outline"
            [nbContextMenu]="chatActions"
            nbContextMenuTag="chat-actions"
          >
          </nb-action>
        </nb-actions>
      </div>
    </nb-card-header>

    <!-- Chat Settings Dialog -->
    <ng-template #settingsDialog>
      <nb-card>
        <nb-card-header>
          Chat Settings
          <button nbButton ghost size="small" (click)="toggleSettings()">
            <nb-icon icon="close-outline"></nb-icon>
          </button>
        </nb-card-header>
        <nb-card-body>
          <div class="setting-item">
            <nb-checkbox [checked]="isMessageExpiryEnabled" (checkedChange)="toggleMessageExpiry()">
              Enable Message Expiry
            </nb-checkbox>
            <nb-select
              *ngIf="isMessageExpiryEnabled"
              [selected]="messageExpiryTime"
              (selectedChange)="updateMessageExpiryTime($event)"
            >
              <nb-option [value]="1">1 hour</nb-option>
              <nb-option [value]="24">24 hours</nb-option>
              <nb-option [value]="72">3 days</nb-option>
              <nb-option [value]="168">7 days</nb-option>
            </nb-select>
          </div>

          <div class="setting-item">
            <nb-checkbox [checked]="isEncryptionEnabled" (checkedChange)="toggleEncryption()">
              Enable End-to-End Encryption
            </nb-checkbox>
          </div>
        </nb-card-body>
      </nb-card>
    </ng-template>

    <nb-card-body [nbSpinner]="loading">
      <div class="messages-container" #messageContainer (scroll)="onScroll($event)">
        <div class="message-list">
          <div *ngIf="loadingMore" class="loading-more">
            <nb-spinner size="small"></nb-spinner>
            Loading more messages...
          </div>
          <app-chat-message
            *ngFor="let message of messages"
            [message]="message"
            [isOwn]="isOwnMessage(message)"
            [showAvatar]="!isOwnMessage(message)"
          >
          </app-chat-message>
        </div>
        <div class="typing-indicator" *ngIf="isTyping">
          <nb-icon icon="message-circle-outline"></nb-icon>
          <span>Typing...</span>
        </div>
      </div>
    </nb-card-body>

    <nb-card-footer>
      <form [formGroup]="messageForm" (ngSubmit)="sendMessage()">
        <nb-form-field>
          <input
            nbInput
            fullWidth
            formControlName="message"
            placeholder="Type a message..."
            [status]="messageForm.get('message')?.errors ? 'danger' : 'basic'"
            (input)="onTyping()"
          />
          <button
            nbButton
            ghost
            type="button"
            (click)="fileInput.click()"
            nbTooltip="Send files"
            nbSuffix
          >
            <nb-icon icon="attach-outline"></nb-icon>
          </button>
          <input
            type="file"
            #fileInput
            style="display: none"
            multiple
            (change)="onFileSelected($event)"
            accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.txt"
          />
          <button nbButton type="submit" status="primary" [disabled]="!messageForm.valid" nbSuffix>
            <nb-icon icon="paper-plane-outline"></nb-icon>
          </button>
        </nb-form-field>
      </form>
    </nb-card-footer>
  </nb-card>
</div>
