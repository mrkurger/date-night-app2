<div class="dashboard-container">
  <h1>Performance Monitoring Dashboard</h1>

  <div class="filter-section">
    <form [formGroup]="filterForm" class="filter-form">
      <nb-form-field appearance="outline">
        <nb-form-field-label>URL Contains</nb-form-field-label>
        <input nbInput fullWidth formControlName="url" placeholder="e.g. /api/users" />
      </nb-form-field>

      <nb-form-field appearance="outline">
        <nb-form-field-label>HTTP Method</nb-form-field-label>
        <nb-select formControlName="method">
          <nb-option value="">All Methods</nb-option>
          <nb-option value="GET">GET</nb-option>
          <nb-option value="POST">POST</nb-option>
          <nb-option value="PUT">PUT</nb-option>
          <nb-option value="DELETE">DELETE</nb-option>
          <nb-option value="PATCH">PATCH</nb-option>
        </nb-select>
      </nb-form-field>

      <nb-form-field appearance="outline">
        <nb-form-field-label>Min Duration (ms)</nb-form-field-label>
        <input
          nbInput
          fullWidth
          formControlName="minDuration"
          type="number"
          placeholder="e.g. 500"
        />
      </nb-form-field>

      <div class="p-field">
        <label for="dateRange">Date Range</label>
        <p-calendar
          id="dateRange"
          selectionMode="range"
          [showIcon]="true"
          formControlName="dateRange"
          placeholder="Select date range"
          dateFormat="yy-mm-dd"
        >
        </p-calendar>
      </div>

      <p-button type="submit" label="Apply Filters" icon="pi pi-search" (click)="applyFilters()">
      </p-button>

      <p-button
        type="button"
        label="Reset"
        icon="pi pi-refresh"
        severity="secondary"
        (click)="resetFilters()"
      >
      </p-button>
    </form>
  </div>

  <div class="dashboard-content">
    <nb-card class="chart-card">
      <nb-card-header>
        <nb-card-header>Slowest Endpoints (Avg Response Time)</nb-card-header>
      </nb-card-header>
      <nb-card-body>
        <div class="chart-container" *ngIf="!isLoading; else loadingTemplate">
          <ngx-charts-bar-horizontal
            [results]="responseTimeByEndpoint"
            [gradient]="true"
            [xAxis]="true"
            [yAxis]="true"
            [showXAxisLabel]="true"
            [showYAxisLabel]="true"
            xAxisLabel="Response Time (ms)"
            yAxisLabel="Endpoint"
          >
          </ngx-charts-bar-horizontal>
        </div>
      </nb-card-body>
    </nb-card>

    <nb-card class="chart-card">
      <nb-card-header>
        <nb-card-header>Response Time Distribution</nb-card-header>
      </nb-card-header>
      <nb-card-body>
        <div class="chart-container" *ngIf="!isLoading; else loadingTemplate">
          <ngx-charts-pie-chart
            [results]="responseTimeDistribution"
            [gradient]="true"
            [legend]="true"
            [labels]="true"
            [doughnut]="true"
          >
          </ngx-charts-pie-chart>
        </div>
      </nb-card-body>
    </nb-card>

    <nb-card class="chart-card">
      <nb-card-header>
        <nb-card-header>Response Time Over Time</nb-card-header>
      </nb-card-header>
      <nb-card-body>
        <div class="chart-container" *ngIf="!isLoading; else loadingTemplate">
          <ngx-charts-line-chart
            [results]="responseTimeOverTime"
            [gradient]="true"
            [xAxis]="true"
            [yAxis]="true"
            [showXAxisLabel]="true"
            [showYAxisLabel]="true"
            xAxisLabel="Date"
            yAxisLabel="Avg Response Time (ms)"
          >
          </ngx-charts-line-chart>
        </div>
      </nb-card-body>
    </nb-card>
  </div>

  <nb-card class="endpoints-list-card">
    <nb-card-header>
      <nb-card-header>Endpoint Performance</nb-card-header>
    </nb-card-header>
    <nb-card-body>
      <div class="table-container" *ngIf="!isLoading; else loadingTemplate">
        <p-table
          [value]="slowestEndpoints"
          [sortField]="sortColumn"
          [sortOrder]="sortDirection === 'asc' ? 1 : -1"
          [paginator]="true"
          [rows]="pageSize"
          [totalRecords]="totalEndpoints"
          [lazy]="true"
          (onLazyLoad)="onPageChange($event)"
          styleClass="p-datatable-sm"
        >
          <ng-template pTemplate="header">
            <tr>
              <th pSortableColumn="url">URL <p-sortIcon field="url"></p-sortIcon></th>
              <th pSortableColumn="method">Method <p-sortIcon field="method"></p-sortIcon></th>
              <th pSortableColumn="avgDuration">
                Avg Time <p-sortIcon field="avgDuration"></p-sortIcon>
              </th>
              <th pSortableColumn="p95Duration">
                P95 Time <p-sortIcon field="p95Duration"></p-sortIcon>
              </th>
              <th pSortableColumn="maxDuration">
                Max Time <p-sortIcon field="maxDuration"></p-sortIcon>
              </th>
              <th pSortableColumn="count">Requests <p-sortIcon field="count"></p-sortIcon></th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-endpoint>
            <tr>
              <td class="url-cell">{{ endpoint.url }}</td>
              <td>
                <span class="method-chip method-{{ endpoint.method.toLowerCase() }}">
                  {{ endpoint.method }}
                </span>
              </td>
              <td>{{ formatDuration(endpoint.avgDuration) }}</td>
              <td>{{ formatDuration(endpoint.p95Duration) }}</td>
              <td>{{ formatDuration(endpoint.maxDuration) }}</td>
              <td>{{ endpoint.count }}</td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </nb-card-body>
  </nb-card>
</div>

<ng-template #loadingTemplate>
  <div class="loading-container">
    <nb-spinner diameter="40"></nb-spinner>
    <p>Loading data...</p>
  </div>
</ng-template>
