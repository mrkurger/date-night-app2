<div class="dashboard-container">
  <h1>Performance Monitoring Dashboard</h1>

  <div class="filter-section">
    <form [formGroup]="filterForm" class="filter-form">
      <nb-form-field appearance="outline">
        <nb-form-field-label>URL Contains</nb-form-field-label>
        <input nbInput fullWidth formControlName="url" placeholder="e.g. /api/users" />
      </nb-form-field>

      <nb-form-field appearance="outline">
        <nb-form-field-label>HTTP Method</nb-form-field-label>
        <nb-select formControlName="method">
          <nb-option value="">All Methods</nb-option>
          <nb-option value="GET">GET</nb-option>
          <nb-option value="POST">POST</nb-option>
          <nb-option value="PUT">PUT</nb-option>
          <nb-option value="DELETE">DELETE</nb-option>
          <nb-option value="PATCH">PATCH</nb-option>
        </nb-select>
      </nb-form-field>

      <nb-form-field appearance="outline">
        <nb-form-field-label>Min Duration (ms)</nb-form-field-label>
        <input
          nbInput
          fullWidth
          formControlName="minDuration"
          type="number"
          placeholder="e.g. 500"
        />
      </nb-form-field>

      <nb-form-field appearance="outline">
        <nb-form-field-label>Date Range</nb-form-field-label>
        <mat-date-range-input [rangePicker]="picker">
          <input matStartDate formControlName="startDate" placeholder="Start date" />
          <input matEndDate formControlName="endDate" placeholder="End date" />
        </mat-date-range-input>
        <nb-datepicker-toggle matSuffix [for]="picker"></nb-datepicker-toggle>
        <mat-date-range-picker #picker></mat-date-range-picker>
      </nb-form-field>

      <button nbButton status="primary" color="primary" (click)="applyFilters()">
        Apply Filters
      </button>

      <button nbButton (click)="resetFilters()">Reset</button>
    </form>
  </div>

  <div class="dashboard-content">
    <nb-card class="chart-card">
      <nb-card-header>
        <nb-card-header>Slowest Endpoints (Avg Response Time)</nb-card-header>
      </nb-card-header>
      <nb-card-body>
        <div class="chart-container" *ngIf="!isLoading; else loadingTemplate">
          <ngx-charts-bar-horizontal
            [results]="responseTimeByEndpoint"
            [gradient]="true"
            [xAxis]="true"
            [yAxis]="true"
            [showXAxisLabel]="true"
            [showYAxisLabel]="true"
            xAxisLabel="Response Time (ms)"
            yAxisLabel="Endpoint"
          >
          </ngx-charts-bar-horizontal>
        </div>
      </nb-card-body>
    </nb-card>

    <nb-card class="chart-card">
      <nb-card-header>
        <nb-card-header>Response Time Distribution</nb-card-header>
      </nb-card-header>
      <nb-card-body>
        <div class="chart-container" *ngIf="!isLoading; else loadingTemplate">
          <ngx-charts-pie-chart
            [results]="responseTimeDistribution"
            [gradient]="true"
            [legend]="true"
            [labels]="true"
            [doughnut]="true"
          >
          </ngx-charts-pie-chart>
        </div>
      </nb-card-body>
    </nb-card>

    <nb-card class="chart-card">
      <nb-card-header>
        <nb-card-header>Response Time Over Time</nb-card-header>
      </nb-card-header>
      <nb-card-body>
        <div class="chart-container" *ngIf="!isLoading; else loadingTemplate">
          <ngx-charts-line-chart
            [results]="responseTimeOverTime"
            [gradient]="true"
            [xAxis]="true"
            [yAxis]="true"
            [showXAxisLabel]="true"
            [showYAxisLabel]="true"
            xAxisLabel="Date"
            yAxisLabel="Avg Response Time (ms)"
          >
          </ngx-charts-line-chart>
        </div>
      </nb-card-body>
    </nb-card>
  </div>

  <nb-card class="endpoints-list-card">
    <nb-card-header>
      <nb-card-header>Endpoint Performance</nb-card-header>
    </nb-card-header>
    <nb-card-body>
      <div class="table-container" *ngIf="!isLoading; else loadingTemplate">
        <app-sort [active]="sortColumn" [direction]="sortDirection" (sortChange)="sortData($event)">
          <table nb-table [dataSource]="slowestEndpoints">
            <!-- URL Column -->
            <ng-container matColumnDef="url">
              <th mat-header-cell *matHeaderCellDef>
                <app-sort-header appSortHeaderId="url">URL</app-sort-header>
              </th>
              <td mat-cell *matCellDef="let endpoint" class="url-cell">{{ endpoint.url }}</td>
            </ng-container>

            <!-- Method Column -->
            <ng-container matColumnDef="method">
              <th mat-header-cell *matHeaderCellDef>
                <app-sort-header appSortHeaderId="method">Method</app-sort-header>
              </th>
              <td mat-cell *matCellDef="let endpoint">
                <span class="method-chip method-{{ endpoint.method.toLowerCase() }}">
                  {{ endpoint.method }}
                </span>
              </td>
            </ng-container>

            <!-- Average Duration Column -->
            <ng-container matColumnDef="avgDuration">
              <th mat-header-cell *matHeaderCellDef>
                <app-sort-header appSortHeaderId="avgDuration">Avg Time</app-sort-header>
              </th>
              <td mat-cell *matCellDef="let endpoint">
                {{ formatDuration(endpoint.avgDuration) }}
              </td>
            </ng-container>

            <!-- P95 Duration Column -->
            <ng-container matColumnDef="p95Duration">
              <th mat-header-cell *matHeaderCellDef>
                <app-sort-header appSortHeaderId="p95Duration">P95 Time</app-sort-header>
              </th>
              <td mat-cell *matCellDef="let endpoint">
                {{ formatDuration(endpoint.p95Duration) }}
              </td>
            </ng-container>

            <!-- Max Duration Column -->
            <ng-container matColumnDef="maxDuration">
              <th mat-header-cell *matHeaderCellDef>
                <app-sort-header appSortHeaderId="maxDuration">Max Time</app-sort-header>
              </th>
              <td mat-cell *matCellDef="let endpoint">
                {{ formatDuration(endpoint.maxDuration) }}
              </td>
            </ng-container>

            <!-- Count Column -->
            <ng-container matColumnDef="count">
              <th mat-header-cell *matHeaderCellDef>
                <app-sort-header appSortHeaderId="count">Requests</app-sort-header>
              </th>
              <td mat-cell *matCellDef="let endpoint">{{ endpoint.count }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>
        </app-sort>

        <nb-paginator
          [length]="totalEndpoints"
          [pageSize]="pageSize"
          [pageSizeOptions]="[5, 10, 25, 50]"
          (page)="onPageChange($event)"
        >
        </nb-paginator>
      </div>
    </nb-card-body>
  </nb-card>
</div>

<ng-template #loadingTemplate>
  <div class="loading-container">
    <nb-spinner diameter="40"></nb-spinner>
    <p>Loading data...</p>
  </div>
</ng-template>
