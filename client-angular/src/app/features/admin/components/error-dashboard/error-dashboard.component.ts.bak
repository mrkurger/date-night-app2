// ===================================================
// CUSTOMIZABLE SETTINGS IN THIS FILE
// ===================================================
// This file contains settings for component configuration (error-dashboard.component)
//
// COMMON CUSTOMIZATIONS:
// - SETTING_NAME: Description of setting (default: value)
//   Related to: other_file.ts:OTHER_SETTING
// ===================================================
import {
  Component,
  OnInit,
  OnDestroy,
  ViewChild,
  CUSTOM_ELEMENTS_SCHEMA,
  TemplateRef,
} from '@angular/core';
import {
  NbPaginatorComponent,
  NbSortComponent,
  NbSortHeaderComponent,
} from '../../../../shared/components/custom-nebular-components';

import { CommonModule } from '@angular/common';
import { ReactiveFormsModule, FormGroup, FormBuilder } from '@angular/forms';
import { TelemetryService } from '../../../../core/services/telemetry.service';
import { TelemetrySocketService } from '../../../../core/services/telemetry-socket.service';
import { ErrorCategory } from '../../../../core/interceptors/http-error.interceptor';
import { NgxChartsModule } from '@swimlane/ngx-charts';
import { catchError, finalize, takeUntil } from 'rxjs/operators';
import { of, Subject } from 'rxjs';
import {
  NbCardModule,
  NbButtonModule,
  NbIconModule,
  NbFormFieldModule,
  NbInputModule,
  NbSelectModule,
  NbDatepickerModule,
  NbSpinnerModule,
  NbTableModule,
  NbBadgeModule,
  NbToggleModule,
  NbTooltipModule,
  NbTreeGridModule,
  NbSortDirection,
  NbSortRequest,
  NbTreeGridDataSource,
  NbTreeGridDataSourceBuilder,
  NbDialogService,
} from '@nebular/theme';

// Define interfaces for pagination and sorting
interface PaginationEvent {
  pageIndex: number;
  pageSize: number;
  length: number;
}

interface ErrorData {
  timestamp: Date;
  errorCode: string;
  category: string;
  statusCode: number;
  url: string;
  userMessage: string;
  technicalMessage: string;
}

@Component({
  selector: 'app-error-dashboard',
  standalone: true,
  imports: [
    CommonModule,
    ReactiveFormsModule,
    NgxChartsModule,
    NbCardModule,
    NbButtonModule,
    NbIconModule,
    NbFormFieldModule,
    NbInputModule,
    NbSelectModule,
    NbDatepickerModule,
    NbSpinnerModule,
    NbTableModule,
    NbBadgeModule,
    NbToggleModule,
    NbTooltipModule,
    NbTreeGridModule,
    NbPaginatorComponent,
    NbSortComponent,
    NbSortHeaderComponent,
  ],
  templateUrl: './error-dashboard.component.html',
  styleUrls: ['./error-dashboard.component.scss'],
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
})
export class ErrorDashboardComponent implements OnInit, OnDestroy {
  @ViewChild(NbSortHeaderComponent) sort: NbSortHeaderComponent;
  @ViewChild('errorDetailsDialog') errorDetailsDialog!: TemplateRef<any>;

  filterForm: FormGroup;
  loading = false;
  isRealtime = false;
  isConnected = false;
  currentPage = 1;
  pageSize = 10;
  totalErrors = 0;
  errorCategories = Object.values(ErrorCategory);
  displayedColumns = ['timestamp', 'category', 'message', 'count', 'actions'];
  dataSource: NbTreeGridDataSource<ErrorData>;
  selectedError: ErrorData | null = null;

  // Chart data
  errorTrendData: any[] = [];
  errorDistributionData: any[] = [];

  // Sorting
  sortColumn = '';
  sortDirection: NbSortDirection = NbSortDirection.NONE;

  private destroy$ = new Subject<void>();

  constructor(
    private formBuilder: FormBuilder,
    private telemetryService: TelemetryService,
    private telemetrySocketService: TelemetrySocketService,
    private dialogService: NbDialogService,
    private dataSourceBuilder: NbTreeGridDataSourceBuilder<ErrorData>,
  ) {
    this.initializeFilterForm();
  }

  ngOnInit(): void {
    this.setupRealtimeConnection();
    this.loadDashboardData();
  }

  ngOnDestroy(): void {
    this.destroy$.next();
    this.destroy$.complete();
    this.telemetrySocketService.disconnect();
  }

  private initializeFilterForm(): void {
    this.filterForm = this.formBuilder.group({
      category: [''],
      statusCode: [''],
      startDate: [null],
      endDate: [null],
    });
  }

  private setupRealtimeConnection(): void {
    this.telemetrySocketService
      .connect()
      .pipe(takeUntil(this.destroy$))
      .subscribe(
        () => {
          this.isConnected = true;
          if (this.isRealtime) {
            this.subscribeToUpdates();
          }
        },
        (error) => {
          console.error('Socket connection error:', error);
          this.isConnected = false;
        },
      );
  }

  private subscribeToUpdates(): void {
    if (this.isConnected) {
      this.telemetrySocketService
        .onErrorUpdate()
        .pipe(takeUntil(this.destroy$))
        .subscribe(
          (update) => {
            this.loadDashboardData();
          },
          (error) => {
            console.error('Error subscription error:', error);
          },
        );
    }
  }

  toggleRealtime(): void {
    this.isRealtime = !this.isRealtime;
    if (this.isRealtime && this.isConnected) {
      this.subscribeToUpdates();
    }
  }

  loadDashboardData(): void {
    this.loading = true;
    const filters = this.filterForm.value;

    this.telemetryService
      .getErrorDashboardData(filters)
      .pipe(
        takeUntil(this.destroy$),
        finalize(() => (this.loading = false)),
      )
      .subscribe(
        (data) => {
          this.dataSource = this.dataSourceBuilder.create(this.transformData(data.errors));
          this.errorTrendData = this.transformTrendData(data.trends);
          this.errorDistributionData = this.transformDistributionData(data.distribution);
          this.totalErrors = data.total;
        },
        (error) => {
          console.error('Error loading dashboard data:', error);
        },
      );
  }

  private transformData(errors: any[]): ErrorData[] {
    return errors.map((error) => ({
      timestamp: new Date(error.timestamp),
      errorCode: error.errorCode,
      category: error.category,
      statusCode: error.statusCode,
      url: error.url,
      userMessage: error.userMessage,
      technicalMessage: error.technicalMessage,
    }));
  }

  private transformTrendData(trends: any[]): any[] {
    return [
      {
        name: 'Errors',
        series: trends.map((trend) => ({
          name: new Date(trend.date),
          value: trend.count,
        })),
      },
    ];
  }

  private transformDistributionData(distribution: any[]): any[] {
    return distribution.map((item) => ({
      name: item.category,
      value: item.count,
    }));
  }

  getCategoryStatus(category: string): string {
    const statusMap: { [key: string]: string } = {
      network: 'warning',
      authentication: 'danger',
      authorization: 'danger',
      validation: 'info',
      server: 'danger',
      client: 'warning',
      timeout: 'warning',
      rate_limit: 'info',
      not_found: 'basic',
      conflict: 'warning',
      unknown: 'basic',
    };
    return statusMap[category] || 'basic';
  }

  applyFilters(): void {
    this.loadDashboardData();
  }

  resetFilters(): void {
    this.filterForm.reset();
    this.loadDashboardData();
  }

  viewErrorDetails(error: ErrorData): void {
    this.selectedError = error;
    this.dialogService.open(this.errorDetailsDialog, {
      context: error,
      hasBackdrop: true,
      closeOnBackdropClick: true,
    });
  }

  onSort(sortRequest: NbSortRequest): void {
    this.sortColumn = sortRequest.column;
    this.sortDirection = sortRequest.direction;
    this.loadDashboardData();
  }

  onPageChange(event: any): void {
    this.currentPage = event.pageIndex + 1;
    this.pageSize = event.pageSize;
    this.loadDashboardData();
  }

  getCategoryLabel(category: string): string {
    return category.replace('_', ' ').toUpperCase();
  }
}
