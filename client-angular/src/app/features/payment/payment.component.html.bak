<div class="payment-container">
  <div class="payment-header">
    <h1>Subscription Plans</h1>
    <p>Choose a subscription plan to unlock premium features</p>
  </div>

  <!-- Current Subscription Info -->
  <nb-card
    *ngIf="currentSubscription && currentSubscription.tier !== 'free'"
    class="current-subscription"
  >
    <nb-card-header>
      <h2>Current Subscription</h2>
    </nb-card-header>
    <nb-card-body>
      <p><strong>Plan:</strong> {{ currentSubscription.tier | titlecase }}</p>
      <p><strong>Expires:</strong> {{ currentSubscription.expires | date: 'medium' }}</p>
      <nb-alert status="warning" *ngIf="currentSubscription.cancelAtPeriodEnd">
        Your subscription will not renew after the expiration date.
      </nb-alert>
      <button
        nbButton
        status="danger"
        (click)="cancelSubscription()"
        [disabled]="loading || currentSubscription.cancelAtPeriodEnd"
      >
        <nb-icon icon="close-outline"></nb-icon>
        {{
          currentSubscription.cancelAtPeriodEnd ? 'Subscription Cancelled' : 'Cancel Subscription'
        }}
      </button>
    </nb-card-body>
  </nb-card>

  <!-- Subscription Plans -->
  <div class="subscription-plans">
    <div class="plan-grid">
      <!-- Free Plan -->
      <nb-card class="plan-card" [class.selected]="selectedPrice === null">
        <nb-card-header>
          <h3>Free</h3>
        </nb-card-header>
        <nb-card-body>
          <div class="price">
            <span class="amount">$0</span>
            <span class="period">/month</span>
          </div>
          <nb-list>
            <nb-list-item>
              <nb-icon icon="checkmark-outline" status="success"></nb-icon>
              Basic profile
            </nb-list-item>
            <nb-list-item>
              <nb-icon icon="checkmark-outline" status="success"></nb-icon>
              Limited ad views
            </nb-list-item>
            <nb-list-item>
              <nb-icon icon="close-outline" status="danger"></nb-icon>
              No ad boosting
            </nb-list-item>
            <nb-list-item>
              <nb-icon icon="checkmark-outline" status="success"></nb-icon>
              Standard support
            </nb-list-item>
          </nb-list>
          <button
            nbButton
            outline
            status="primary"
            (click)="selectPrice(null)"
            [disabled]="currentSubscription?.tier === 'free'"
          >
            {{ currentSubscription?.tier === 'free' ? 'Current Plan' : 'Select' }}
          </button>
        </nb-card-body>
      </nb-card>

      <!-- Premium Plans -->
      <nb-card
        *ngFor="let price of subscriptionPrices"
        class="plan-card"
        [class.selected]="selectedPrice?.id === price.id"
      >
        <nb-card-header>
          <h3>{{ price.productName }}</h3>
        </nb-card-header>
        <nb-card-body>
          <div class="price">
            <span class="amount">{{ formatPrice(price) }}</span>
          </div>
          <p class="description">{{ price.description }}</p>
          <button
            nbButton
            status="primary"
            (click)="selectPrice(price)"
            [disabled]="currentSubscription?.tier === price.productName.toLowerCase()"
          >
            {{
              currentSubscription?.tier === price.productName.toLowerCase()
                ? 'Current Plan'
                : 'Select'
            }}
          </button>
        </nb-card-body>
      </nb-card>
    </div>
  </div>

  <!-- Payment Form -->
  <nb-card *ngIf="selectedPrice" class="payment-form">
    <nb-card-header>
      <h2>Payment Information</h2>
    </nb-card-header>
    <nb-card-body>
      <form [formGroup]="paymentForm" (ngSubmit)="onSubmit()">
        <nb-form-field>
          <label for="name">Name on Card</label>
          <input
            nbInput
            fullWidth
            id="name"
            formControlName="name"
            [status]="
              paymentForm.get('name')?.invalid && paymentForm.get('name')?.touched
                ? 'danger'
                : 'basic'
            "
          />
          <nb-alert
            status="danger"
            *ngIf="paymentForm.get('name')?.invalid && paymentForm.get('name')?.touched"
          >
            Name is required
          </nb-alert>
        </nb-form-field>

        <nb-form-field>
          <label for="email">Email</label>
          <input
            nbInput
            fullWidth
            id="email"
            formControlName="email"
            [status]="
              paymentForm.get('email')?.invalid && paymentForm.get('email')?.touched
                ? 'danger'
                : 'basic'
            "
          />
          <nb-alert
            status="danger"
            *ngIf="paymentForm.get('email')?.invalid && paymentForm.get('email')?.touched"
          >
            Valid email is required
          </nb-alert>
        </nb-form-field>

        <nb-form-field>
          <label for="card-element">Credit or Debit Card</label>
          <div id="card-element" class="card-element" #cardElement></div>
          <nb-alert status="danger" *ngIf="cardErrors">{{ cardErrors }}</nb-alert>
        </nb-form-field>

        <div class="form-actions">
          <button
            nbButton
            status="success"
            size="large"
            fullWidth
            type="submit"
            [disabled]="paymentForm.invalid || loading"
          >
            <nb-spinner *ngIf="loading" size="small"></nb-spinner>
            Subscribe Now
          </button>
        </div>

        <div class="payment-details">
          <p>You will be charged {{ formatPrice(selectedPrice) }}</p>
          <p class="hint-text">
            Your subscription will automatically renew. You can cancel anytime.
          </p>
        </div>
      </form>
    </nb-card-body>
  </nb-card>
</div>
