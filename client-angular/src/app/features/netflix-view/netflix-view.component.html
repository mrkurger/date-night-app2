<app-main-layout activeView="netflix">
  <div class="netflix-container">
    <!-- Hero Section with Nebular Card -->
    <nb-card *ngIf="featuredAd" class="hero-card">
      <nb-card-header>
        <div class="hero-header">
          <nb-user
            [name]="getAdvertiserName(featuredAd)"
            [picture]="getAdvertiserImage(featuredAd)"
            [title]="getLocationString(featuredAd)"
            [showTitle]="true"
            size="large"
            [onlineStatus]="featuredAd.isAdvertiserOnline ? 'success' : 'basic'"
          >
          </nb-user>
          <div class="hero-actions">
            <button
              nbButton
              status="primary"
              (click)="onHeroAction('view', getAdIdAsString(featuredAd._id))"
            >
              <nb-icon icon="info-circle-outline"></nb-icon>
              View Profile
            </button>
            <button
              nbButton
              ghost
              (click)="onHeroAction('favorite', getAdIdAsString(featuredAd._id))"
            >
              <nb-icon icon="heart-outline"></nb-icon>
              Add to Favorites
            </button>
            <button nbButton ghost (click)="onHeroAction('chat', getAdIdAsString(featuredAd._id))">
              <nb-icon icon="message-circle-outline"></nb-icon>
              Start Chat
            </button>
          </div>
        </div>
      </nb-card-header>

      <nb-card-body [style.backgroundImage]="'url(' + getMediaUrl(featuredAd) + ')'">
        <div class="hero-content">
          <h1>{{ featuredAd.title }}</h1>
          <p class="hero-description">{{ featuredAd.description }}</p>

          <!-- Tags -->
          <div class="hero-tags" *ngIf="featuredAd.tags && featuredAd.tags.length > 0">
            <nb-badge
              *ngFor="let tag of featuredAd.tags.slice(0, 5)"
              [text]="tag"
              status="primary"
              position="top start"
            >
            </nb-badge>
          </div>
        </div>
      </nb-card-body>
    </nb-card>

    <!-- Main Content -->
    <div class="netflix-content">
      <!-- Filters Bar -->
      <div class="filters-bar">
        <div class="container">
          <div class="filters-content">
            <h2 class="section-title">Browse Profiles</h2>
            <button nbButton outline (click)="openFilters()">
              <nb-icon icon="options-2-outline"></nb-icon>
              Filters
            </button>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div class="loading-container" *ngIf="loading">
        <nb-spinner status="primary" size="large"></nb-spinner>
        <p class="loading-text">Loading profiles...</p>
      </div>

      <!-- Error State -->
      <div class="error-container" *ngIf="error && !loading">
        <nb-icon icon="alert-circle-outline" status="danger" size="large"></nb-icon>
        <p class="error-text">{{ error }}</p>
        <button nbButton status="primary" (click)="loadAds()">
          <nb-icon icon="refresh-outline"></nb-icon>
          Try Again
        </button>
      </div>

      <!-- Netflix-style Rows -->
      <div class="netflix-rows" *ngIf="!loading && !error">
        <div class="row-section" *ngFor="let category of categories; let i = index">
          <div class="container">
            <h2 class="row-title">{{ category }}</h2>

            <!-- Empty state handling -->
            <div class="empty-row" *ngIf="adsByCategory[category]?.length === 0">
              <p class="empty-row-text">No profiles in this category</p>
            </div>

            <!-- Grid of Cards -->
            <div class="card-grid" *ngIf="adsByCategory[category]?.length > 0">
              <nb-card
                *ngFor="let ad of adsByCategory[category]"
                class="netflix-card"
                (click)="viewAdDetails(ad.id)"
              >
                <nb-card-header>
                  <nb-user
                    [name]="ad.advertiserName"
                    [picture]="ad.advertiserImage"
                    [onlineStatus]="ad.isAdvertiserOnline ? 'success' : 'basic'"
                    size="small"
                  >
                  </nb-user>
                </nb-card-header>

                <nb-card-body [style.backgroundImage]="'url(' + getMediaUrl(ad) + ')'">
                  <div class="card-content">
                    <h3>{{ ad.title }}</h3>
                    <p>{{ ad.description?.substring(0, 100) + '...' }}</p>

                    <!-- Tags -->
                    <div class="card-tags" *ngIf="ad.tags?.length > 0">
                      <nb-badge
                        *ngFor="let tag of ad.tags.slice(0, 3)"
                        [text]="tag"
                        status="primary"
                        position="top start"
                      >
                      </nb-badge>
                    </div>
                  </div>
                </nb-card-body>

                <nb-card-footer>
                  <button
                    nbButton
                    ghost
                    size="small"
                    (click)="$event.stopPropagation(); onCardAction({ id: 'view', itemId: ad.id })"
                  >
                    <nb-icon icon="info-circle-outline"></nb-icon>
                  </button>
                  <button
                    nbButton
                    ghost
                    size="small"
                    (click)="
                      $event.stopPropagation(); onCardAction({ id: 'favorite', itemId: ad.id })
                    "
                  >
                    <nb-icon icon="heart-outline"></nb-icon>
                  </button>
                  <button
                    nbButton
                    ghost
                    size="small"
                    (click)="$event.stopPropagation(); onCardAction({ id: 'chat', itemId: ad.id })"
                  >
                    <nb-icon icon="message-circle-outline"></nb-icon>
                  </button>
                </nb-card-footer>
              </nb-card>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Action Button -->
  <button
    nbButton
    status="primary"
    size="large"
    class="floating-action-button"
    (click)="openFilters()"
  >
    <nb-icon icon="options-2-outline"></nb-icon>
  </button>

  <!-- Filters Dialog -->
  <ng-template #filtersDialog let-ref="dialogRef">
    <nb-card>
      <nb-card-header>
        <div class="dialog-header">
          <h5><nb-icon icon="funnel-outline"></nb-icon> Filter Profiles</h5>
          <button nbButton ghost size="small" (click)="ref.close()">
            <nb-icon icon="close-outline"></nb-icon>
          </button>
        </div>
      </nb-card-header>

      <nb-card-body>
        <form [formGroup]="filterForm">
          <nb-form-field>
            <label>Category</label>
            <nb-select fullWidth formControlName="category">
              <nb-option value="">All Categories</nb-option>
              <nb-option value="Escort">Escort</nb-option>
              <nb-option value="Striptease">Striptease</nb-option>
              <nb-option value="Massage">Massage</nb-option>
              <nb-option value="Companion">Companion</nb-option>
              <nb-option value="Other">Other</nb-option>
            </nb-select>
          </nb-form-field>

          <nb-form-field>
            <label>Location</label>
            <nb-select fullWidth formControlName="location">
              <nb-option value="">All Locations</nb-option>
              <nb-option value="Oslo">Oslo</nb-option>
              <nb-option value="Bergen">Bergen</nb-option>
              <nb-option value="Trondheim">Trondheim</nb-option>
              <nb-option value="Stavanger">Stavanger</nb-option>
              <nb-option value="Tromsø">Tromsø</nb-option>
              <nb-option value="Kristiansand">Kristiansand</nb-option>
            </nb-select>
          </nb-form-field>

          <div class="toggle-field">
            <label>Touring Status</label>
            <nb-toggle formControlName="touringOnly" status="primary">
              Show only touring profiles
            </nb-toggle>
          </div>
        </form>
      </nb-card-body>

      <nb-card-footer>
        <button nbButton status="basic" (click)="resetFilters()">
          <nb-icon icon="refresh-outline"></nb-icon>
          Reset
        </button>
        <button nbButton status="primary" (click)="applyFilters(); ref.close()">
          <nb-icon icon="checkmark-outline"></nb-icon>
          Apply
        </button>
      </nb-card-footer>
    </nb-card>
  </ng-template>
</app-main-layout>
