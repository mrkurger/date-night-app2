<nb-card [ngClass]="getMessageClasses()">
  <nb-card-body>
    <!-- User avatar and info -->
    <div class="message__header" *ngIf="!isCurrentUser && showSender">
      <nb-user [name]="getSenderName()" [picture]="getSenderProfileImage()" size="medium"></nb-user>
    </div>

    <div class="message__content">
      <!-- Loading state while decrypting -->
      <div class="message__loading" *ngIf="isDecrypting">
        <nb-spinner size="small"></nb-spinner>
        <span>Decrypting message...</span>
      </div>

      <!-- System message -->
      <div
        class="message__text message__text--system"
        *ngIf="message.type === 'system' && !isDecrypting"
      >
        {{ decryptedContent }}
      </div>

      <!-- Regular message -->
      <div class="message__text" *ngIf="message.type !== 'system' && !isDecrypting">
        <!-- Encryption indicator -->
        <nb-icon
          *ngIf="message.isEncrypted && !decryptionFailed"
          icon="lock-outline"
          status="success"
          class="message__encryption-indicator"
        ></nb-icon>

        <!-- Decryption failed indicator -->
        <nb-icon
          *ngIf="decryptionFailed"
          icon="unlock-outline"
          status="danger"
          class="message__encryption-indicator"
        ></nb-icon>

        <!-- Message content -->
        <span [innerHTML]="decryptedContent | linkify"></span>
      </div>

      <!-- Attachments -->
      <div
        class="message__attachments"
        *ngIf="message.attachments && message.attachments.length > 0"
      >
        <nb-card class="attachment" *ngFor="let attachment of message.attachments">
          <!-- Image attachment -->
          <nb-card-body class="attachment__image" *ngIf="attachment.type === 'image'">
            <img
              [src]="attachment.url"
              [alt]="attachment.name || 'Image attachment'"
              (click)="openAttachment(attachment)"
            />
          </nb-card-body>

          <!-- File attachment -->
          <nb-card-body class="attachment__file" *ngIf="attachment.type !== 'image'">
            <nb-icon icon="file-text-outline" class="attachment__icon"></nb-icon>
            <div class="attachment__details">
              <div class="attachment__name">{{ attachment.name }}</div>
              <div class="attachment__size">{{ attachment.size | fileSize }}</div>
            </div>
            <button nbButton ghost size="small" (click)="downloadAttachment(attachment)">
              <nb-icon icon="download-outline"></nb-icon>
            </button>
          </nb-card-body>
        </nb-card>
      </div>
    </div>

    <div class="message__footer">
      <span class="message__time">{{ getTimestamp() | timeAgo }}</span>

      <!-- Read indicator -->
      <nb-badge
        *ngIf="isCurrentUser"
        [text]="message.read ? 'Read' : 'Sent'"
        [status]="message.read ? 'success' : 'basic'"
        position="bottom right"
      ></nb-badge>

      <!-- Expiry indicator -->
      <div class="message__expiry" *ngIf="message.expiresAt">
        <nb-icon icon="clock-outline"></nb-icon>
        <span class="message__expiry-time">Expires {{ getExpiryDate() | timeAgo }}</span>
      </div>
    </div>
  </nb-card-body>
</nb-card>
