<p-card [ngClass]="getMessageClasses()">
  <!-- User avatar and info -->
  <div class="message__header" *ngIf="!isCurrentUser && showSender">
    <div class="message__avatar">
      <p-avatar
        [image]="getSenderProfileImage()"
        shape="circle"
        size="large"
        [label]="getSenderName().charAt(0)"
        styleClass="mr-2"
      ></p-avatar>
      <span class="message__sender">{{ getSenderName() }}</span>
    </div>
  </div>

  <div class="message__content">
    <!-- Loading state while decrypting -->
    <div class="message__loading" *ngIf="isDecrypting">
      <p-progressSpinner
        [style]="{ width: '20px', height: '20px' }"
        styleClass="custom-spinner"
      ></p-progressSpinner>
      <span>Decrypting message...</span>
    </div>

    <!-- System message -->
    <div
      class="message__text message__text--system"
      *ngIf="message.type === 'system' && !isDecrypting"
    >
      {{ decryptedContent }}
    </div>

    <!-- Regular message -->
    <div class="message__text" *ngIf="message.type !== 'system' && !isDecrypting">
      <!-- Encryption indicator -->
      <span
        class="message__encryption-indicator"
        *ngIf="message.isEncrypted && !decryptionFailed"
        pTooltip="End-to-end encrypted"
        tooltipPosition="top"
      >
        <i class="pi pi-lock"></i>
      </span>

      <!-- Decryption failed indicator -->
      <span
        class="message__encryption-indicator message__encryption-indicator--failed"
        *ngIf="decryptionFailed"
        pTooltip="Failed to decrypt message"
        tooltipPosition="top"
      >
        <i class="pi pi-lock-open"></i>
      </span>

      <!-- Message content -->
      <span [innerHTML]="decryptedContent | linkify"></span>
    </div>

    <!-- Attachments -->
    <div class="message__attachments" *ngIf="message.attachments && message.attachments.length > 0">
      <p-card class="attachment" *ngFor="let attachment of message.attachments">
        <!-- Image attachment -->
        <div class="attachment__image" *ngIf="attachment.type === 'image'">
          <img
            [src]="attachment.url"
            [alt]="attachment.name || 'Image attachment'"
            (click)="openAttachment(attachment)"
            class="attachment__preview"
          />
        </div>

        <!-- File attachment -->
        <div class="attachment__file" *ngIf="attachment.type !== 'image'">
          <div class="attachment__icon">
            <i class="pi pi-file" aria-hidden="true"></i>
          </div>
          <div class="attachment__details">
            <div class="attachment__name">{{ attachment.name }}</div>
            <div class="attachment__size">{{ attachment.size | fileSize }}</div>
          </div>
          <p-button
            icon="pi pi-download"
            styleClass="p-button-rounded p-button-text"
            (click)="downloadAttachment(attachment)"
            pTooltip="Download file"
            tooltipPosition="top"
          >
          </p-button>
        </div>
      </p-card>
    </div>
  </div>

  <!-- Message timestamp -->
  <div class="message__footer">
    <small class="message__time">{{ message.timestamp | timeAgo }}</small>
  </div>
</p-card>
