<div class="dashboard-container">
  <h1>Performance Monitoring Dashboard</h1>

  <div class="filter-section">
    <form [formGroup]="filterForm" class="filter-form">
      <mat-form-field appearance="outline">
        <mat-label>URL Contains</mat-label>
        <input matInput formControlName="url" placeholder="e.g. /api/users" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>HTTP Method</mat-label>
        <mat-select formControlName="method">
          <mat-option value="">All Methods</mat-option>
          <mat-option value="GET">GET</mat-option>
          <mat-option value="POST">POST</mat-option>
          <mat-option value="PUT">PUT</mat-option>
          <mat-option value="DELETE">DELETE</mat-option>
          <mat-option value="PATCH">PATCH</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Min Duration (ms)</mat-label>
        <input matInput formControlName="minDuration" type="number" placeholder="e.g. 500" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Date Range</mat-label>
        <mat-date-range-input [rangePicker]="picker">
          <input matStartDate formControlName="startDate" placeholder="Start date" />
          <input matEndDate formControlName="endDate" placeholder="End date" />
        </mat-date-range-input>
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-date-range-picker #picker></mat-date-range-picker>
      </mat-form-field>

      <button mat-raised-button color="primary" (click)="applyFilters()">Apply Filters</button>

      <button mat-button (click)="resetFilters()">Reset</button>
    </form>
  </div>

  <div class="dashboard-content">
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>Slowest Endpoints (Avg Response Time)</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container" *ngIf="!isLoading; else loadingTemplate">
          <ngx-charts-bar-horizontal
            [results]="responseTimeByEndpoint"
            [gradient]="true"
            [xAxis]="true"
            [yAxis]="true"
            [showXAxisLabel]="true"
            [showYAxisLabel]="true"
            xAxisLabel="Response Time (ms)"
            yAxisLabel="Endpoint"
          >
          </ngx-charts-bar-horizontal>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>Response Time Distribution</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container" *ngIf="!isLoading; else loadingTemplate">
          <ngx-charts-pie-chart
            [results]="responseTimeDistribution"
            [gradient]="true"
            [legend]="true"
            [labels]="true"
            [doughnut]="true"
          >
          </ngx-charts-pie-chart>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>Response Time Over Time</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container" *ngIf="!isLoading; else loadingTemplate">
          <ngx-charts-line-chart
            [results]="responseTimeOverTime"
            [gradient]="true"
            [xAxis]="true"
            [yAxis]="true"
            [showXAxisLabel]="true"
            [showYAxisLabel]="true"
            xAxisLabel="Date"
            yAxisLabel="Avg Response Time (ms)"
          >
          </ngx-charts-line-chart>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <mat-card class="endpoints-list-card">
    <mat-card-header>
      <mat-card-title>Endpoint Performance</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="table-container" *ngIf="!isLoading; else loadingTemplate">
        <table mat-table [dataSource]="slowestEndpoints" matSort (matSortChange)="sortData($event)">
          <!-- URL Column -->
          <ng-container matColumnDef="url">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>URL</th>
            <td mat-cell *matCellDef="let endpoint" class="url-cell">{{ endpoint.url }}</td>
          </ng-container>

          <!-- Method Column -->
          <ng-container matColumnDef="method">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Method</th>
            <td mat-cell *matCellDef="let endpoint">
              <span class="method-chip method-{{ endpoint.method.toLowerCase() }}">
                {{ endpoint.method }}
              </span>
            </td>
          </ng-container>

          <!-- Average Duration Column -->
          <ng-container matColumnDef="avgDuration">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Avg Time</th>
            <td mat-cell *matCellDef="let endpoint">{{ formatDuration(endpoint.avgDuration) }}</td>
          </ng-container>

          <!-- P95 Duration Column -->
          <ng-container matColumnDef="p95Duration">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>P95 Time</th>
            <td mat-cell *matCellDef="let endpoint">{{ formatDuration(endpoint.p95Duration) }}</td>
          </ng-container>

          <!-- Max Duration Column -->
          <ng-container matColumnDef="maxDuration">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Max Time</th>
            <td mat-cell *matCellDef="let endpoint">{{ formatDuration(endpoint.maxDuration) }}</td>
          </ng-container>

          <!-- Count Column -->
          <ng-container matColumnDef="count">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Requests</th>
            <td mat-cell *matCellDef="let endpoint">{{ endpoint.count }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>

        <mat-paginator
          [length]="totalEndpoints"
          [pageSize]="pageSize"
          [pageSizeOptions]="[5, 10, 25, 50]"
          (page)="onPageChange($event)"
        >
        </mat-paginator>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<ng-template #loadingTemplate>
  <div class="loading-container">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Loading data...</p>
  </div>
</ng-template>
