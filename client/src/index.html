<!DOCTYPE html>
<html ng-app="classifiedsApp">
  <head>
    
    <meta charset="UTF-8">
    <title>Travelling Fortune Tellers Classified Ads</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-sanitize.min.js"></script>
    <link rel="stylesheet" href="/assets/styles/main.css">
    <script src="app.js"></script>
    <script src="assets/icons.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }

      .deck {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        padding: 20px;
      }

      .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: transform 0.2s;
        position: relative;
        overflow: hidden;
        padding: 0;
      }

      .card:hover {
        transform: translateY(-5px);
      }

      .card-image {
        width: 100%;
        height: 300px;
        object-fit: cover;
        border-radius: 12px 12px 0 0;
      }

      .card-content {
        padding: 20px;
        background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        color: white;
        max-height: 30vh;  /* Limit to 30% of viewport height */
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .card-content h3 {
        margin: 0 0 8px 0;
        font-size: 1.2em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .card-content p {
        margin: 0;
        font-size: 0.9em;
        display: -webkit-box;
        -webkit-line-clamp: 3;  /* Limit to 3 lines */
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .card-content .btn {
        margin-top: auto;  /* Push button to bottom */
        align-self: flex-start;
      }

      .tinder-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        margin: 40px auto;
        max-width: 500px;
        position: relative;
        transition: transform 0.3s;
        overflow: hidden;
        padding: 0;
      }

      .tinder-card.ng-enter {
        animation: slideIn 0.3s ease-out;
      }

      .card-image {
        width: 100%;
        height: 300px;
        object-fit: cover;
        border-radius: 12px 12px 0 0;
      }

      .online-indicator {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #4CAF50;
        box-shadow: 0 0 0 2px white;
      }

      .distance-badge {
        padding: 8px 12px;
        background: rgba(255,255,255,0.9);
        color: #333;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 500;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }

      .card-badges {
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        z-index: 2;
      }

      .action-badges {
        display: flex;
        gap: 8px;
      }

      .badge-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: none;
        background: rgba(255,255,255,0.9);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
      }

      .badge-btn:hover {
        transform: scale(1.1);
      }

      .phone-badge {
        color: #4CAF50;
      }

      .chat-badge {
        color: #2196F3;
      }

      .tinder-controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
      }

      .btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
      }

      .btn:hover {
        background: #0056b3;
      }

      .btn:disabled {
        background: #ccc;
      }

      .view-switcher {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 20px 0;
      }

      @keyframes slideIn {
        from { 
          opacity: 0;
          transform: translateX(100px);
        }
        to { 
          opacity: 1;
          transform: translateX(0);
        }
      }

      /* Form styles */
      form {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      input, select, textarea {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-sizing: border-box;
      }

      h3 {
        color: #2c3e50;
        margin-bottom: 15px;
      }

      .ad-meta {
        color: #666;
        font-size: 0.9em;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
      }

      .proximity-card {
        display: flex;
        align-items: center;
        gap: 20px;
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin: 10px 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .online-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #4CAF50;
        margin-right: 8px;
      }

      .proximity-view {
        max-width: 800px;
        margin: 0 auto;
      }

      .location-preview {
        height: 200px;
        background: #eee;
        border-radius: 8px;
        margin: 10px 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .coords-display {
        font-family: monospace;
        background: #f8f9fa;
        padding: 4px 8px;
        border-radius: 4px;
        margin-left: 8px;
      }

      .sort-controls {
        margin: 20px 0;
        display: flex;
        gap: 10px;
      }

      .social-login {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      
      .social-btn {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        width: 100%;
      }
      
      .social-btn:hover {
        background: #f8f9fa;
      }
      
      .github { color: #24292e; }
      .google { color: #4285f4; }
      .reddit { color: #ff4500; }
      .apple { color: #000000; }

      .chat-interface {
        position: fixed;
        bottom: 0;
        right: 20px;
        width: 300px;
        background: white;
        border-radius: 12px 12px 0 0;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
      }

      .chat-header {
        padding: 10px;
        background: #007bff;
        color: white;
        border-radius: 12px 12px 0 0;
        cursor: pointer;
      }

      .chat-messages {
        height: 300px;
        overflow-y: auto;
        padding: 10px;
      }

      .chat-input {
        display: flex;
        padding: 10px;
        border-top: 1px solid #eee;
      }

      .chat-message {
        margin: 5px 0;
        padding: 8px;
        border-radius: 8px;
        max-width: 80%;
      }

      .chat-message.sent {
        background: #007bff;
        color: white;
        margin-left: auto;
      }

      .chat-message.received {
        background: #f0f0f0;
      }

      .notification-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #ff4444;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 12px;
      }

      .chat-previews {
        position: fixed;
        bottom: 0;
        right: 340px;
        width: 250px;
        background: white;
        border-radius: 12px 12px 0 0;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      }

      .chat-preview-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
      }

      .chat-preview-item:hover {
        background: #f8f9fa;
      }

      .chat-preview-item.unread {
        background: #e3f2fd;
      }

      /* Modal styles */
      .modal {
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.6);
      }
      .modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 300px;
        border-radius: 8px;
      }
      .modal-close {
        float: right;
        font-size: 24px;
        cursor: pointer;
      }
      .navbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .navbar-links a {
        margin: 0 8px;
        cursor: pointer;
        color: #007bff;
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div ng-controller="AdsController">
      <!-- Navigation Bar -->
      <nav class="navbar">
        <span class="navbar-brand">Fortune Tellers Ads</span>
        <!-- Use ng-show instead of ng-if to always render the container -->
        <div class="navbar-links" ng-show="!user">
          <a ng-click="openLoginModal()"><span ng-bind-html="icons.login"></span></a>
          <a ng-click="openRegisterModal()"><span ng-bind-html="icons.add"></span></a>
          <a ng-click="socialLogin('github')"><span ng-bind-html="icons.github"></span></a>
          <a ng-click="socialLogin('google')"><span ng-bind-html="icons.google"></span></a>
          <a ng-click="socialLogin('reddit')"><span ng-bind-html="icons.reddit"></span></a>
          <a ng-click="socialLogin('apple')"><span ng-bind-html="icons.apple"></span></a>
        </div>
        <div class="navbar-links" ng-show="user">
          <span>Welcome, {{user.username}}! ({{user.role}})</span>
          <a ng-click="logout()"><span ng-bind-html="icons.logout"></span></a>
        </div>
      </nav>
      
      <!-- County Menu -->
      <div class="county-menu" style="margin-bottom:20px;">
        <label for="countySelect">Select County:</label>
        <select id="countySelect" ng-model="selectedCounty" ng-change="filterByCounty()">
          <option value="">All Counties</option>
          <option ng-repeat="county in counties" value="{{county}}">{{county}}</option>
        </select>
        <button class="btn" ng-click="resetCountyFilter()">Reset Filter</button>
      </div>
      
      <!-- Login Modal -->
      <div class="modal" ng-show="showLoginModal">
        <div class="modal-content">
          <span class="modal-close" ng-click="closeLoginModal()">&times;</span>
          <h2>Login</h2>
          <form ng-submit="login()">
            <input type="text" ng-model="loginData.username" placeholder="Username" required />
            <input type="password" ng-model="loginData.password" placeholder="Password" required />
            <button type="submit">Login</button>
          </form>
        </div>
      </div>
      
      <!-- Registration Modal -->
      <div class="modal" ng-show="showRegisterModal">
        <div class="modal-content">
          <span class="modal-close" ng-click="closeRegisterModal()">&times;</span>
          <h2>Register</h2>
          <form ng-submit="register()">
            <input type="text" ng-model="registerData.username" placeholder="Username" required />
            <input type="password" ng-model="registerData.password" placeholder="Password" required />
            <input type="password" ng-model="registerData.confirmPassword" placeholder="Confirm Password" required />
            <select ng-model="registerData.role" required>
              <option value="" disabled selected>Select Role</option>
              <option value="user">User</option>
              <option value="advertiser">Advertiser</option>
            </select>
            <button type="submit">Register</button>
          </form>
        </div>
      </div>
      
      <h1>Classified Ads</h1>
      
      <!-- User status -->
      <div ng-if="user">
        Welcome, {{user.username}}! ({{user.role}})
        <button class="icon-button" ng-click="logout()">
          <span ng-bind-html="icons.logout"></span>
          Logout
        </button>
      </div>

      <!-- View switcher -->
      <div class="view-switcher">
        <button class="btn" ng-click="view='tinder'" ng-class="{active: view==='tinder'}">Tinder View</button>
        <button class="btn" ng-click="view='netflix'" ng-class="{active: view==='netflix'}">Netflix View</button>
        <button class="btn" ng-click="view='proximity'" ng-class="{active: view==='proximity'}">
          <span ng-bind-html="icons.location"></span>
          Nearby
        </button>
      </div>
      
      <!-- Tinder style view -->
      <div ng-if="view==='tinder'" class="tinder-view">
        <h2>Fortune Teller Cards</h2>
        <div class="tinder-card" ng-if="filteredAds.length">
          <img ng-src="{{filteredAds[currentTinderIndex].profileImage}}" class="card-image" alt="Profile"
            ng-mouseover="changeImage(filteredAds[currentTinderIndex])" ng-mouseleave="restoreImage(filteredAds[currentTinderIndex])">
          <span ng-if="filteredAds[currentTinderIndex].advertiserOnline" class="online-indicator"></span>
          <div class="card-badges">
            <span class="distance-badge">{{filteredAds[currentTinderIndex].distance | number:1}} km</span>
            <div class="action-badges">
              <button class="badge-btn phone-badge" ng-click="callAdvertiser(filteredAds[currentTinderIndex].contact)">
                <span>📞</span>
              </button>
              <button class="badge-btn chat-badge" ng-click="startChat(filteredAds[currentTinderIndex].advertiser)">
                <span>💬</span>
              </button>
            </div>
          </div>
          <div class="card-content">
            <h3>{{filteredAds[currentTinderIndex].title}}</h3>
            <p>{{filteredAds[currentTinderIndex].description}}</p>
            <button class="btn" ng-click="startChat(filteredAds[currentTinderIndex].advertiser)">
              Chat with Fortune Teller
            </button>
          </div>
        </div>
        <div class="tinder-controls">
          <button class="btn" ng-click="prevAd()" ng-disabled="!filteredAds.length">← Previous</button>
          <button class="btn" ng-click="nextAd()" ng-disabled="!filteredAds.length">Next →</button>
        </div>
      </div>
      
      <!-- Netflix style view -->
      <div ng-if="view==='netflix'" class="netflix-view">
        <h2>Fortune Teller Gallery</h2>
        <div class="deck">
          <div class="card" ng-repeat="ad in ads">
            <img ng-src="{{ad.profileImage}}" class="card-image" alt="Profile"
              ng-mouseover="changeImage(ad)" ng-mouseleave="restoreImage(ad)">
            <span ng-if="ad.advertiserOnline" class="online-indicator"></span>
            <div class="card-badges">
              <span class="distance-badge">{{ad.distance | number:1}} km</span>
              <div class="action-badges">
                <button class="badge-btn phone-badge" ng-click="callAdvertiser(ad.contact)">
                  <span>📞</span>
                </button>
                <button class="badge-btn chat-badge" ng-click="startChat(ad.advertiser)">
                  <span>💬</span>
                </button>
              </div>
            </div>
            <div class="card-content">
              <h3>{{ad.title}}</h3>
              <p>{{ad.description}}</p>
              <button class="btn" ng-click="startChat(ad.advertiser)">
                Chat with Fortune Teller
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Enhanced proximity view -->
      <div ng-if="view==='proximity'" class="proximity-view">
        <h2>Nearby Ads</h2>
        <div ng-if="!userLocation" class="location-prompt">
          <p>Share your location to see nearby fortune tellers</p>
          <button class="btn" ng-click="getUserLocation()">
            <span ng-bind-html="icons.location"></span>
            Enable Location
          </button>
        </div>
        
        <div ng-if="userLocation" class="sort-controls">
          <button class="btn" ng-click="sortByDistance()">Sort by Distance</button>
          <button class="btn" ng-click="sortByOnlineStatus()">Online First</button>
        </div>

        <div class="proximity-list">
          <div class="proximity-card" ng-repeat="ad in nearbyAds">
            <div>
              <h3>
                <span ng-if="ad.advertiserOnline" class="online-indicator"></span>
                {{ad.title}}
              </h3>
              <p>{{ad.description}}</p>
              <div class="ad-meta">
                <p><span class="distance-badge">{{ad.distance}} km away</span></p>
                <p><strong>📍</strong> {{ad.location}}</p>
                <p><strong>📞</strong> {{ad.contact}}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Ad creation form with coordinates -->
      <div ng-if="user && user.role === 'advertiser'">
        <h2>Add New Ad</h2>
        <form ng-submit="addAd()">
          <input type="text" ng-model="newAd.title" placeholder="Title" required />
          <textarea ng-model="newAd.description" placeholder="Description" required></textarea>
          <input type="text" ng-model="newAd.contact" placeholder="Contact" required />
          <input type="text" ng-model="newAd.location" placeholder="Location" required />
          
          <!-- Location picker -->
          <div class="location-picker">
            <button type="button" class="btn" ng-click="getCurrentLocation()">
              Use Current Location
            </button>
            <span class="coords-display" ng-if="newAd.coordinates">
              {{newAd.coordinates.coordinates[1] | number:6}}, 
              {{newAd.coordinates.coordinates[0] | number:6}}
            </span>
          </div>
          
          <button type="submit" ng-disabled="!newAd.coordinates">Submit</button>
        </form>
      </div>

      <!-- Travel Plan for Advertisers -->
      <div ng-if="user && user.role === 'advertiser'">
        <h2>Save Travel Plan</h2>
        <form ng-submit="saveTravelPlan()">
          <label>Select Counties:</label>
          <select multiple ng-model="travelPlan" ng-options="county for county in counties"></select>
          <button type="submit" class="btn">Save Travel Plan</button>
        </form>
      </div>

      <!-- Chat Interface -->
      <div class="chat-interface" ng-if="activeChat" ng-class="{minimized: chatMinimized}">
        <div class="chat-header" ng-click="toggleChat()">
          Chat with {{activeChatUser.username}}
          <span ng-if="activeChatUser.online" class="online-indicator"></span>
        </div>
        <div class="chat-messages">
          <div class="chat-message" 
               ng-repeat="message in chatMessages" 
               ng-class="{sent: message.sender === user.id}">
            {{message.message}}
          </div>
        </div>
        <div class="chat-input">
          <input type="text" 
                 ng-model="newMessage" 
                 placeholder="Type your message..."
                 ng-keypress="$event.keyCode === 13 && sendMessage()">
          <button class="btn" ng-click="sendMessage()">Send</button>
        </div>
      </div>

      <!-- Chat Previews -->
      <div class="chat-previews" ng-if="user && chatPreviews.length">
        <div class="chat-header">
          Messages
          <span class="notification-badge" ng-if="unreadCount">{{unreadCount}}</span>
        </div>
        <div class="chat-preview-item" 
             ng-repeat="preview in chatPreviews"
             ng-class="{unread: preview.unreadCount > 0}"
             ng-click="startChat(preview._id)">
          <div class="preview-user">{{preview.user[0].username}}</div>
          <div class="preview-message">{{preview.lastMessage}}</div>
          <div class="preview-time">{{preview.timestamp | date:'shortTime'}}</div>
        </div>
      </div>
    </div>
  </body>
</html>